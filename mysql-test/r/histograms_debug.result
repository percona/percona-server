# Testing of histogram statistics that uses DEBUG functionality.
#
# Simulate a failure due to dropping histograms during DROP TABLE
#
CREATE TABLE t1 (col1 INT, col2 INT);
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1, col2 WITH 10 BUCKETS;
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics created for column 'col1'.
test.t1	histogram	status	Histogram statistics created for column 'col2'.
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
test	t1	col2
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
test	t1	col2
SELECT COUNT(*) FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
COUNT(*)
1
SET DEBUG='+d,fail_after_drop_histograms';
DROP TABLE t1;
ERROR HY000: Unable to remove column statistics for column 'dummy_column' in table 'test'.'t1'
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
test	t1	col2
SELECT COUNT(*) FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
COUNT(*)
1
SET DEBUG='-d,fail_after_drop_histograms';
#
# Simulate a failure due to dropping histograms during ALTER TABLE
#
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
test	t1	col2
SELECT COUNT(*) FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1' AND COLUMN_NAME = 'col2';
COUNT(*)
1
SET DEBUG='+d,fail_after_drop_histograms';
ALTER TABLE t1 DROP COLUMN col2;
ERROR HY000: Unable to remove column statistics for column 'dummy_column' in table 'test'.'t1'
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
test	t1	col2
SELECT COUNT(*) FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1' AND COLUMN_NAME = 'col2';
COUNT(*)
1
SET DEBUG='-d,fail_after_drop_histograms';
#
# Simulate a failure due to renaming histograms during ALTER TABLE RENAME
#
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
test	t1	col2
SELECT COUNT(*) FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
COUNT(*)
1
SET DEBUG='+d,fail_after_rename_histograms';
ALTER TABLE t1 RENAME TO t2;
ERROR HY000: Unable to update column statistics for column 'dummy_column' in table 'test'.'t1'
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
test	t1	col2
SELECT COUNT(*) FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'test' AND TABLE_NAME = 't1';
COUNT(*)
1
SET DEBUG='-d,fail_after_rename_histograms';
DROP TABLE t1;
#
# Check that histogram with sampling works as expected
#
SET DEBUG='+d,histogram_force_sampling';
CREATE TABLE t1 (col1 DOUBLE);
INSERT INTO t1 SELECT RAND(1);
INSERT INTO t1 SELECT RAND(2) FROM t1;
INSERT INTO t1 SELECT RAND(3) FROM t1;
INSERT INTO t1 SELECT RAND(4) FROM t1;
INSERT INTO t1 SELECT RAND(5) FROM t1;
INSERT INTO t1 SELECT RAND(6) FROM t1;
INSERT INTO t1 SELECT RAND(7) FROM t1;
INSERT INTO t1 SELECT RAND(8) FROM t1;
INSERT INTO t1 SELECT RAND(9) FROM t1;
INSERT INTO t1 SELECT RAND(10) FROM t1;
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 4 BUCKETS;
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics created for column 'col1'.
SELECT schema_name, table_name, column_name,
JSON_REMOVE(histogram, '$."last-updated"')
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME	JSON_REMOVE(histogram, '$."last-updated"')
test	t1	col1	{"buckets": [], "data-type": "double", "null-values": 0.0, "collation-id": 8, "sampling-rate": 0.5, "histogram-type": "singleton", "number-of-buckets-specified": 4}
SET DEBUG='-d,histogram_force_sampling';
DROP TABLE t1;
#
# Bug#26020352 WL8943:ASSERTION `M_THD->GET_TRANSACTION()->IS_EMPTY(
#              TRANSACTION_CTX::STMT) && M
#
CREATE TABLE t1 (col1 INT);
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 10 BUCKETS;
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics created for column 'col1'.
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
SET DEBUG='+d,histogram_fail_after_open_table';
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 10 BUCKETS;
Table	Op	Msg_type	Msg_text
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
SET DEBUG='-d,histogram_fail_after_open_table';
DROP TABLE t1;
#
# Bug#26027240 WL8943:VIRTUAL BOOL SQL_CMD_ANALYZE_TABLE::EXECUTE(THD*):
#              ASSERTION `FALSE' FAIL
#
CREATE TABLE t1 (col1 INT);
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 10 BUCKETS;
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics created for column 'col1'.
SET DEBUG='+d,histogram_fail_during_lock_for_write';
ANALYZE TABLE t1 DROP HISTOGRAM ON col1;
Table	Op	Msg_type	Msg_text
# Since we have simulated a fail, the histogram should still be present.
# However, since this is a simulation of failure no error is reported.
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
test	t1	col1
SET DEBUG='-d,histogram_fail_during_lock_for_write';
ANALYZE TABLE t1 DROP HISTOGRAM ON col1;
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics removed for column 'col1'.
# The histogram should now be gone.
SELECT schema_name, table_name, column_name
FROM information_schema.COLUMN_STATISTICS;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME
DROP TABLE t1;
#
# Bug#26772858 MDL FOR COLUMN STATISTICS IS NOT PROPERLY REFLECTED IN
# P_S.METADATA_LOCKS
#
CREATE TABLE t1 (col1 INT);
SET DEBUG_SYNC='store_histogram_after_write_lock SIGNAL histogram_1_waiting WAIT_FOR continue_store_histogram';
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 2 BUCKETS;;
SET DEBUG_SYNC='now WAIT_FOR histogram_1_waiting';
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, COLUMN_NAME
FROM performance_schema.metadata_locks
WHERE LOCK_TYPE = "EXCLUSIVE"
    AND OBJECT_TYPE = "COLUMN STATISTICS"
  ORDER BY OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, COLUMN_NAME;
OBJECT_TYPE	OBJECT_SCHEMA	OBJECT_NAME	COLUMN_NAME
COLUMN STATISTICS	test	t1	col1
SET DEBUG_SYNC='mdl_acquire_lock_wait SIGNAL histogram_2_lock_waiting';
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 2 BUCKETS;;
SET DEBUG_SYNC='now WAIT_FOR histogram_2_lock_waiting';
SELECT OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, INDEX_NAME
FROM performance_schema.events_waits_current
WHERE OBJECT_TYPE = "COLUMN STATISTICS"
  ORDER BY OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME, INDEX_NAME;
OBJECT_TYPE	OBJECT_SCHEMA	OBJECT_NAME	INDEX_NAME
COLUMN STATISTICS	test	t1	col1
SET DEBUG_SYNC='now SIGNAL continue_store_histogram';
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics created for column 'col1'.
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics created for column 'col1'.
DROP TABLE t1;
#
# Bug#27672693  HISTOGRAMS: ASSERTION FAILED: !THD->TX_READ_ONLY
#
CREATE TABLE t1(col1 INT);
SET LOCAL TRANSACTION READ ONLY;
INSERT INTO t1 (col1) VALUES (1);
ERROR 25006: Cannot execute statement in a READ ONLY transaction.
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 16 BUCKETS;
Table	Op	Msg_type	Msg_text
	histogram	Error	The server is in read-only mode.
SET LOCAL TRANSACTION READ WRITE;
INSERT INTO t1 (col1) VALUES (1);
ANALYZE TABLE t1 UPDATE HISTOGRAM ON col1 WITH 16 BUCKETS;
Table	Op	Msg_type	Msg_text
test.t1	histogram	status	Histogram statistics created for column 'col1'.
DROP TABLE t1;
#
# Additional tests for bug#29634540 "DROP DATABASE OF 1 MILLION
# TABLES ...".
#
# Check that DROP DATABASE statement doesn't acquire metadata locks
# on column statistics while dropping it.
#
CREATE DATABASE mysqltest;
CREATE TABLE mysqltest.t1 (i INT);
INSERT INTO mysqltest.t1 VALUES (1), (2), (3);
ANALYZE TABLE mysqltest.t1 UPDATE HISTOGRAM ON i WITH 10 BUCKETS;
Table	Op	Msg_type	Msg_text
mysqltest.t1	histogram	status	Histogram statistics created for column 'i'.
CREATE TABLE mysqltest.t2 (j INT);
# Run DROP DATABASE which will be paused near its end.
SET DEBUG_SYNC = 'rm_table_no_locks_before_binlog SIGNAL drop_waiting WAIT_FOR drop_resume';
DROP DATABASE mysqltest;
connect con1, localhost, root,,;
# Wait until DROP DATABASE gets paused and check what MDL
# it has acquired. There should be X locks on both tables
# and no locks on column statistics.
SET DEBUG_SYNC = 'now WAIT_FOR drop_waiting';
SELECT object_type, object_schema, object_name, column_name, lock_type
FROM performance_schema.metadata_locks
WHERE object_schema = "mysqltest"
  ORDER BY object_type, object_schema, object_name, column_name, lock_type;
object_type	object_schema	object_name	column_name	lock_type
SCHEMA	mysqltest	NULL	NULL	EXCLUSIVE
TABLE	mysqltest	t1	NULL	EXCLUSIVE
TABLE	mysqltest	t2	NULL	EXCLUSIVE
#
# Run concurrent ANALYZE TABLE ... DROP HISTOGRAM on table from
# database being dropped.
ANALYZE TABLE mysqltest.t1 DROP HISTOGRAM ON i;
connect con2, localhost, root,,;
# Check that it will be blocked thanks to table MDL.
# Unpause DROP DATABASE.
SET DEBUG_SYNC = 'now SIGNAL drop_resume';
disconnect con2;
connection con1;
# Reap ANALYZE TABLE ... DROP HISTOGRAM, which should not have
# found any histograms since database has been dropped.
Table	Op	Msg_type	Msg_text
mysqltest.t1	histogram	Error	Unknown database 'mysqltest'
disconnect con1;
connection default;
# Reap DROP DATABASE
# Clean-up.
SET DEBUG_SYNC = 'RESET';
#
# Bug#35419418 CH Benchmark failing with crash in histogram code of mysql optimizer
#
# When updating an existing string histogram we access freed memory
# which can lead to a crash. This test updates equi-height and
# singleton histograms twice on all supported column types.
# Without the bugfix this test will sometimes cause a crash and will
# produce a "heap-use-after-free" error in ASAN builds.
CREATE TABLE all_types (
col_bool BOOLEAN,
col_bit BIT(4),
col_tinyint TINYINT,
col_smallint SMALLINT,
col_mediumint MEDIUMINT,
col_integer INTEGER,
col_bigint BIGINT,
col_tinyint_unsigned TINYINT UNSIGNED,
col_smallint_unsigned SMALLINT UNSIGNED,
col_mediumint_unsigned MEDIUMINT UNSIGNED,
col_integer_unsigned INTEGER UNSIGNED,
col_bigint_unsigned BIGINT UNSIGNED,
col_float FLOAT,
col_double DOUBLE,
col_decimal DECIMAL(2, 2),
col_date DATE,
col_time TIME,
col_year YEAR,
col_datetime DATETIME,
col_timestamp TIMESTAMP NULL,
col_char CHAR(255),
col_varchar VARCHAR(255),
col_tinytext TINYTEXT,
col_text TEXT,
col_mediumtext MEDIUMTEXT,
col_longtext LONGTEXT,
col_binary BINARY(255),
col_varbinary VARBINARY(255),
col_tinyblob TINYBLOB,
col_blob BLOB,
col_mediumblob MEDIUMBLOB,
col_longblob LONGBLOB,
col_enum ENUM('zero', 'one', 'two'),
col_set SET('zero', 'one', 'two')
);
# Insert 3 different values into each column (except for BOOLEAN) so
# that we get equi-height histograms when we call UPDATE HISTOGRAM ON
# ... WITH 2 BUCKETS and singleton histograms when we use WITH 4 BUCKETS.
INSERT INTO all_types VALUES (
FALSE,                 # BOOLEAN
b'0000',               # BIT
0,                     # TINYINT
0,                     # SMALLINT
0,                     # MEDIUMINT
0,                     # INTEGER
0,                     # BIGINT
0,                     # TINYINT_UNSIGNED
0,                     # SMALLINT_UNSIGNED
0,                     # MEDIUMINT_UNSIGNED
0,                     # INTEGER_UNSIGNED
0,                     # BIGINT_UNSIGNED
0,                     # FLOAT
0,                     # DOUBLE
00.00,                 # DECIMAL(2, 2)
'1000-01-01',          # DATE
'00:00:00.000000',     # TIME
1901,                  # YEAR
'1000-01-01 00:00:00', # DATETIME
'1971-01-01 00:00:00', # TIMESTAMP
'0',                   # CHAR
'0',                   # VARCHAR
'0',                   # TINYTEXT
'0',                   # TEXT
'0',                   # MEDIUMTEXT
'0',                   # LONGTEXT
'0',                   # BINARY
'0',                   # VARBINARY
'0',                   # TINYBLOB
'0',                   # BLOB
'0',                   # MEDIUMBLOB
'0',                   # LONGBLOB
'zero',                 # ENUM
'zero'                  # SET
);
INSERT INTO all_types VALUES (
TRUE,                  # BOOLEAN
b'0001',               # BIT
1,                     # TINYINT
1,                     # SMALLINT
1,                     # MEDIUMINT
1,                     # INTEGER
1,                     # BIGINT
1,                     # TINYINT_UNSIGNED
1,                     # SMALLINT_UNSIGNED
1,                     # MEDIUMINT_UNSIGNED
1,                     # INTEGER_UNSIGNED
1,                     # BIGINT_UNSIGNED
1,                     # FLOAT
1,                     # DOUBLE
00.01,                 # DECIMAL(2, 2)
'1001-01-01',          # DATE
'00:00:00.000001',     # TIME
1902,                  # YEAR
'1001-01-01 00:00:00', # DATETIME
'1971-01-01 00:00:01', # TIMESTAMP
'1',                   # CHAR
'1',                   # VARCHAR
'1',                   # TINYTEXT
'1',                   # TEXT
'1',                   # MEDIUMTEXT
'1',                   # LONGTEXT
'1',                   # BINARY
'1',                   # VARBINARY
'1',                   # TINYBLOB
'1',                   # BLOB
'1',                   # MEDIUMBLOB
'1',                   # LONGBLOB
'one',                 # ENUM
'one'                  # SET
);
INSERT INTO all_types VALUES (
TRUE,                  # BOOLEAN
b'0010',               # BIT
2,                     # TINYINT
2,                     # SMALLINT
2,                     # MEDIUMINT
2,                     # INTEGER
2,                     # BIGINT
2,                     # TINYINT_UNSIGNED
2,                     # SMALLINT_UNSIGNED
2,                     # MEDIUMINT_UNSIGNED
2,                     # INTEGER_UNSIGNED
2,                     # BIGINT_UNSIGNED
2,                     # FLOAT
2,                     # DOUBLE
00.02,                 # DECIMAL(2, 2)
'1002-01-01',          # DATE
'00:00:00.000002',     # TIME
1903,                  # YEAR
'1002-01-01 00:00:00', # DATETIME
'1971-01-01 00:00:02', # TIMESTAMP
'2',                   # CHAR
'2',                   # VARCHAR
'2',                   # TINYTEXT
'2',                   # TEXT
'2',                   # MEDIUMTEXT
'2',                   # LONGTEXT
'2',                   # BINARY
'2',                   # VARBINARY
'2',                   # TINYBLOB
'2',                   # BLOB
'2',                   # MEDIUMBLOB
'2',                   # LONGBLOB
'two',                 # ENUM
'two'                  # SET
);
#
# Build singleton histograms.
#
ANALYZE TABLE all_types UPDATE HISTOGRAM ON
col_bool,
col_bit,
col_tinyint,
col_smallint,
col_mediumint,
col_integer,
col_bigint,
col_tinyint_unsigned,
col_smallint_unsigned,
col_mediumint_unsigned,
col_integer_unsigned,
col_bigint_unsigned,
col_float,
col_double,
col_decimal,
col_date,
col_time,
col_year,
col_datetime,
col_timestamp,
col_char,
col_varchar,
col_tinytext,
col_text,
col_mediumtext,
col_longtext,
col_binary,
col_varbinary,
col_tinyblob,
col_blob,
col_mediumblob,
col_longblob,
col_enum,
col_set
WITH 4 BUCKETS;
Table	Op	Msg_type	Msg_text
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_binary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bit'.
test.all_types	histogram	status	Histogram statistics created for column 'col_blob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bool'.
test.all_types	histogram	status	Histogram statistics created for column 'col_char'.
test.all_types	histogram	status	Histogram statistics created for column 'col_date'.
test.all_types	histogram	status	Histogram statistics created for column 'col_datetime'.
test.all_types	histogram	status	Histogram statistics created for column 'col_decimal'.
test.all_types	histogram	status	Histogram statistics created for column 'col_double'.
test.all_types	histogram	status	Histogram statistics created for column 'col_enum'.
test.all_types	histogram	status	Histogram statistics created for column 'col_float'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_set'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_text'.
test.all_types	histogram	status	Histogram statistics created for column 'col_time'.
test.all_types	histogram	status	Histogram statistics created for column 'col_timestamp'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinytext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varbinary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varchar'.
test.all_types	histogram	status	Histogram statistics created for column 'col_year'.
ANALYZE TABLE all_types UPDATE HISTOGRAM ON
col_bool,
col_bit,
col_tinyint,
col_smallint,
col_mediumint,
col_integer,
col_bigint,
col_tinyint_unsigned,
col_smallint_unsigned,
col_mediumint_unsigned,
col_integer_unsigned,
col_bigint_unsigned,
col_float,
col_double,
col_decimal,
col_date,
col_time,
col_year,
col_datetime,
col_timestamp,
col_char,
col_varchar,
col_tinytext,
col_text,
col_mediumtext,
col_longtext,
col_binary,
col_varbinary,
col_tinyblob,
col_blob,
col_mediumblob,
col_longblob,
col_enum,
col_set
WITH 4 BUCKETS;
Table	Op	Msg_type	Msg_text
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_binary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bit'.
test.all_types	histogram	status	Histogram statistics created for column 'col_blob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bool'.
test.all_types	histogram	status	Histogram statistics created for column 'col_char'.
test.all_types	histogram	status	Histogram statistics created for column 'col_date'.
test.all_types	histogram	status	Histogram statistics created for column 'col_datetime'.
test.all_types	histogram	status	Histogram statistics created for column 'col_decimal'.
test.all_types	histogram	status	Histogram statistics created for column 'col_double'.
test.all_types	histogram	status	Histogram statistics created for column 'col_enum'.
test.all_types	histogram	status	Histogram statistics created for column 'col_float'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_set'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_text'.
test.all_types	histogram	status	Histogram statistics created for column 'col_time'.
test.all_types	histogram	status	Histogram statistics created for column 'col_timestamp'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinytext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varbinary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varchar'.
test.all_types	histogram	status	Histogram statistics created for column 'col_year'.
SELECT schema_name, table_name, column_name,
JSON_EXTRACT(histogram, '$."histogram-type"') AS should_be_singleton
FROM information_schema.column_statistics;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME	should_be_singleton
test	all_types	col_bigint	"singleton"
test	all_types	col_bigint_unsigned	"singleton"
test	all_types	col_binary	"singleton"
test	all_types	col_bit	"singleton"
test	all_types	col_blob	"singleton"
test	all_types	col_bool	"singleton"
test	all_types	col_char	"singleton"
test	all_types	col_date	"singleton"
test	all_types	col_datetime	"singleton"
test	all_types	col_decimal	"singleton"
test	all_types	col_double	"singleton"
test	all_types	col_enum	"singleton"
test	all_types	col_float	"singleton"
test	all_types	col_integer	"singleton"
test	all_types	col_integer_unsigned	"singleton"
test	all_types	col_longblob	"singleton"
test	all_types	col_longtext	"singleton"
test	all_types	col_mediumblob	"singleton"
test	all_types	col_mediumint	"singleton"
test	all_types	col_mediumint_unsigned	"singleton"
test	all_types	col_mediumtext	"singleton"
test	all_types	col_set	"singleton"
test	all_types	col_smallint	"singleton"
test	all_types	col_smallint_unsigned	"singleton"
test	all_types	col_text	"singleton"
test	all_types	col_time	"singleton"
test	all_types	col_timestamp	"singleton"
test	all_types	col_tinyblob	"singleton"
test	all_types	col_tinyint	"singleton"
test	all_types	col_tinyint_unsigned	"singleton"
test	all_types	col_tinytext	"singleton"
test	all_types	col_varbinary	"singleton"
test	all_types	col_varchar	"singleton"
test	all_types	col_year	"singleton"
ANALYZE TABLE all_types DROP HISTOGRAM ON
col_bool,
col_bit,
col_tinyint,
col_smallint,
col_mediumint,
col_integer,
col_bigint,
col_tinyint_unsigned,
col_smallint_unsigned,
col_mediumint_unsigned,
col_integer_unsigned,
col_bigint_unsigned,
col_float,
col_double,
col_decimal,
col_date,
col_time,
col_year,
col_datetime,
col_timestamp,
col_char,
col_varchar,
col_tinytext,
col_text,
col_mediumtext,
col_longtext,
col_binary,
col_varbinary,
col_tinyblob,
col_blob,
col_mediumblob,
col_longblob,
col_enum,
col_set;
Table	Op	Msg_type	Msg_text
test.all_types	histogram	status	Histogram statistics removed for column 'col_bigint'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_bigint_unsigned'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_binary'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_bit'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_blob'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_bool'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_char'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_date'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_datetime'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_decimal'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_double'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_enum'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_float'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_integer'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_integer_unsigned'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_longblob'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_longtext'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_mediumblob'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_mediumint'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_mediumint_unsigned'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_mediumtext'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_set'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_smallint'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_smallint_unsigned'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_text'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_time'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_timestamp'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_tinyblob'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_tinyint'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_tinyint_unsigned'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_tinytext'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_varbinary'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_varchar'.
test.all_types	histogram	status	Histogram statistics removed for column 'col_year'.
#
# Build equi-height histograms.
#
ANALYZE TABLE all_types UPDATE HISTOGRAM ON
col_bool,
col_bit,
col_tinyint,
col_smallint,
col_mediumint,
col_integer,
col_bigint,
col_tinyint_unsigned,
col_smallint_unsigned,
col_mediumint_unsigned,
col_integer_unsigned,
col_bigint_unsigned,
col_float,
col_double,
col_decimal,
col_date,
col_time,
col_year,
col_datetime,
col_timestamp,
col_char,
col_varchar,
col_tinytext,
col_text,
col_mediumtext,
col_longtext,
col_binary,
col_varbinary,
col_tinyblob,
col_blob,
col_mediumblob,
col_longblob,
col_enum,
col_set
WITH 2 BUCKETS;
Table	Op	Msg_type	Msg_text
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_binary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bit'.
test.all_types	histogram	status	Histogram statistics created for column 'col_blob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bool'.
test.all_types	histogram	status	Histogram statistics created for column 'col_char'.
test.all_types	histogram	status	Histogram statistics created for column 'col_date'.
test.all_types	histogram	status	Histogram statistics created for column 'col_datetime'.
test.all_types	histogram	status	Histogram statistics created for column 'col_decimal'.
test.all_types	histogram	status	Histogram statistics created for column 'col_double'.
test.all_types	histogram	status	Histogram statistics created for column 'col_enum'.
test.all_types	histogram	status	Histogram statistics created for column 'col_float'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_set'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_text'.
test.all_types	histogram	status	Histogram statistics created for column 'col_time'.
test.all_types	histogram	status	Histogram statistics created for column 'col_timestamp'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinytext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varbinary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varchar'.
test.all_types	histogram	status	Histogram statistics created for column 'col_year'.
ANALYZE TABLE all_types UPDATE HISTOGRAM ON
col_bool,
col_bit,
col_tinyint,
col_smallint,
col_mediumint,
col_integer,
col_bigint,
col_tinyint_unsigned,
col_smallint_unsigned,
col_mediumint_unsigned,
col_integer_unsigned,
col_bigint_unsigned,
col_float,
col_double,
col_decimal,
col_date,
col_time,
col_year,
col_datetime,
col_timestamp,
col_char,
col_varchar,
col_tinytext,
col_text,
col_mediumtext,
col_longtext,
col_binary,
col_varbinary,
col_tinyblob,
col_blob,
col_mediumblob,
col_longblob,
col_enum,
col_set
WITH 2 BUCKETS;
Table	Op	Msg_type	Msg_text
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bigint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_binary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bit'.
test.all_types	histogram	status	Histogram statistics created for column 'col_blob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_bool'.
test.all_types	histogram	status	Histogram statistics created for column 'col_char'.
test.all_types	histogram	status	Histogram statistics created for column 'col_date'.
test.all_types	histogram	status	Histogram statistics created for column 'col_datetime'.
test.all_types	histogram	status	Histogram statistics created for column 'col_decimal'.
test.all_types	histogram	status	Histogram statistics created for column 'col_double'.
test.all_types	histogram	status	Histogram statistics created for column 'col_enum'.
test.all_types	histogram	status	Histogram statistics created for column 'col_float'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer'.
test.all_types	histogram	status	Histogram statistics created for column 'col_integer_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_longtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_mediumtext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_set'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_smallint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_text'.
test.all_types	histogram	status	Histogram statistics created for column 'col_time'.
test.all_types	histogram	status	Histogram statistics created for column 'col_timestamp'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyblob'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinyint_unsigned'.
test.all_types	histogram	status	Histogram statistics created for column 'col_tinytext'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varbinary'.
test.all_types	histogram	status	Histogram statistics created for column 'col_varchar'.
test.all_types	histogram	status	Histogram statistics created for column 'col_year'.
SELECT schema_name, table_name, column_name,
JSON_EXTRACT(histogram, '$."histogram-type"') AS should_be_equiheight
FROM information_schema.column_statistics;
SCHEMA_NAME	TABLE_NAME	COLUMN_NAME	should_be_equiheight
test	all_types	col_bigint	"equi-height"
test	all_types	col_bigint_unsigned	"equi-height"
test	all_types	col_binary	"equi-height"
test	all_types	col_bit	"equi-height"
test	all_types	col_blob	"equi-height"
test	all_types	col_bool	"singleton"
test	all_types	col_char	"equi-height"
test	all_types	col_date	"equi-height"
test	all_types	col_datetime	"equi-height"
test	all_types	col_decimal	"equi-height"
test	all_types	col_double	"equi-height"
test	all_types	col_enum	"equi-height"
test	all_types	col_float	"equi-height"
test	all_types	col_integer	"equi-height"
test	all_types	col_integer_unsigned	"equi-height"
test	all_types	col_longblob	"equi-height"
test	all_types	col_longtext	"equi-height"
test	all_types	col_mediumblob	"equi-height"
test	all_types	col_mediumint	"equi-height"
test	all_types	col_mediumint_unsigned	"equi-height"
test	all_types	col_mediumtext	"equi-height"
test	all_types	col_set	"equi-height"
test	all_types	col_smallint	"equi-height"
test	all_types	col_smallint_unsigned	"equi-height"
test	all_types	col_text	"equi-height"
test	all_types	col_time	"singleton"
test	all_types	col_timestamp	"equi-height"
test	all_types	col_tinyblob	"equi-height"
test	all_types	col_tinyint	"equi-height"
test	all_types	col_tinyint_unsigned	"equi-height"
test	all_types	col_tinytext	"equi-height"
test	all_types	col_varbinary	"equi-height"
test	all_types	col_varchar	"equi-height"
test	all_types	col_year	"equi-height"
DROP TABLE all_types;
#
# Verify that we can update existing histograms twice with USING DATA.
#
CREATE TABLE t(x VARCHAR(8));
INSERT INTO t VALUES ('a'), ('b'), ('c');
# USING DATA with singleton string histogram.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [["base64:type254:MA==", 0.3333333333333333], ["base64:type254:MQ==", 0.6666666666666666], ["base64:type254:Mg==", 1.0]], "data-type": "string", "null-values": 0.0, "collation-id": 255, "sampling-rate": 1.0, "histogram-type": "singleton", "number-of-buckets-specified": 4}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [["base64:type254:MA==", 0.3333333333333333], ["base64:type254:MQ==", 0.6666666666666666], ["base64:type254:Mg==", 1.0]], "data-type": "string", "null-values": 0.0, "collation-id": 255, "sampling-rate": 1.0, "histogram-type": "singleton", "number-of-buckets-specified": 4}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
ANALYZE TABLE t DROP HISTOGRAM ON x;
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics removed for column 'x'.
# USING DATA with equi-height string histogram.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [["base64:type254:MA==", "base64:type254:MQ==", 0.6666666666666666, 2], ["base64:type254:Mg==", "base64:type254:Mg==", 1.0, 1]], "data-type": "string", "null-values": 0.0, "collation-id": 255, "sampling-rate": 1.0, "histogram-type": "equi-height", "number-of-buckets-specified": 2}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [["base64:type254:MA==", "base64:type254:MQ==", 0.6666666666666666, 2], ["base64:type254:Mg==", "base64:type254:Mg==", 1.0, 1]], "data-type": "string", "null-values": 0.0, "collation-id": 255, "sampling-rate": 1.0, "histogram-type": "equi-height", "number-of-buckets-specified": 2}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
DROP TABLE t;
CREATE TABLE t(x INT);
INSERT INTO t VALUES (1), (2), (3);
# USING DATA with singleton integer histogram.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [[0, 0.3333333333333333], [1, 0.6666666666666666], [2, 1.0]], "data-type": "int", "null-values": 0.0, "collation-id": 8, "sampling-rate": 1.0, "histogram-type": "singleton", "number-of-buckets-specified": 4}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [[0, 0.3333333333333333], [1, 0.6666666666666666], [2, 1.0]], "data-type": "int", "null-values": 0.0, "collation-id": 8, "sampling-rate": 1.0, "histogram-type": "singleton", "number-of-buckets-specified": 4}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
ANALYZE TABLE t DROP HISTOGRAM ON x;
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics removed for column 'x'.
# USING DATA with equi-height integer histogram.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [[0, 1, 0.6666666666666666, 2], [2, 2, 1.0, 1]], "data-type": "int", "null-values": 0.0, "collation-id": 8, "sampling-rate": 1.0, "histogram-type": "equi-height", "number-of-buckets-specified": 2}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
ANALYZE TABLE t UPDATE HISTOGRAM ON x USING DATA '{"buckets": [[0, 1, 0.6666666666666666, 2], [2, 2, 1.0, 1]], "data-type": "int", "null-values": 0.0, "collation-id": 8, "sampling-rate": 1.0, "histogram-type": "equi-height", "number-of-buckets-specified": 2}';
Table	Op	Msg_type	Msg_text
test.t	histogram	status	Histogram statistics created for column 'x'.
DROP TABLE t;
