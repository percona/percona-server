////////////////
// test for delimiter-only string
////////////////
# restart:--plugin-dir=:
SELECT @@plugin_dir;
@@plugin_dir
MYSQL_BASEDIR
////////////////
// test for several-delimiters string
////////////////
# restart:--plugin-dir=:::
SELECT @@plugin_dir;
@@plugin_dir
MYSQL_BASEDIR:MYSQL_BASEDIR:MYSQL_BASEDIR
////////////////
// test for empty entries
////////////////
# restart:--plugin-dir=/some/dir/1::/some/dir/2::/some/dir/3:
SELECT @@plugin_dir;
@@plugin_dir
/some/dir/1/:MYSQL_BASEDIR:/some/dir/2/:MYSQL_BASEDIR:/some/dir/3/
////////////////
// test for some plugin dir entry exceeds size limit
////////////////
call mtr.add_suppression("Plugin dir max len was exceed");
# restart:--plugin-dir=/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/some/fake/dir/1:/some/fake/dir/2
SELECT @@plugin_dir;
@@plugin_dir
/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/012/:/some/fake/dir/1/:/some/fake/dir/2/
////////////////
// test for whole plugin dir exceeds size limit
////////////////
# restart:--plugin-dir=/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789
SELECT @@plugin_dir;
@@plugin_dir
/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/:/0123456789/0123456789/0123456789/0123456789/0123456789/0123456789/
////////////////
// test for using command-line option including UDF
////////////////
# restart:--plugin-dir=/some/fake/dir:EXAMPLE_PLUGIN_DIR:PLUGIN_AUTH_DIR:UDF_EXAMPLE_LIB_DIR:/some/fake/dir/again PLUGIN_AUTH_LOAD_ADD EXAMPLE_PLUGIN_LOAD_ADD
SELECT @@plugin_dir;
@@plugin_dir
/some/fake/dir/:EXAMPLE_PLUGIN_DIR/:PLUGIN_AUTH_DIR/:UDF_EXAMPLE_LIB_DIR/:/some/fake/dir/again/
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'EXAMPLE';
COUNT(*)
1
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'test_plugin_server';
COUNT(*)
1
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'cleartext_plugin_server';
COUNT(*)
1
CREATE FUNCTION metaphon RETURNS STRING SONAME "UDF_EXAMPLE_LIB";
DROP FUNCTION metaphon;
////////////////
// test for using "INSTALL PLUGIN" statement
////////////////
# restart:--plugin-dir=/some/fake/dir:EXAMPLE_PLUGIN_DIR:PLUGIN_AUTH_DIR:/some/fake/dir/again
SELECT @@plugin_dir;
@@plugin_dir
/some/fake/dir/:EXAMPLE_PLUGIN_DIR/:PLUGIN_AUTH_DIR/:/some/fake/dir/again/
INSTALL PLUGIN example SONAME 'ha_example.so';
INSTALL PLUGIN test_plugin_server SONAME 'auth_test_plugin.so';
INSTALL PLUGIN cleartext_plugin_server SONAME 'auth_test_plugin.so';
INSTALL PLUGIN no_such_plugin SONAME 'no_such_object';
ERROR HY000: Can't open shared library '/some/fake/dir/again/no_such_object' (errno: 2 /some/fake/dir/again/no_such_object: cannot open shared object file: No such file or directory)
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'EXAMPLE';
COUNT(*)
1
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'test_plugin_server';
COUNT(*)
1
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'cleartext_plugin_server';
COUNT(*)
1
UNINSTALL PLUGIN example;
UNINSTALL PLUGIN test_plugin_server;
UNINSTALL PLUGIN cleartext_plugin_server;
////////////////
// test for fake plugin file from command line option
// Copy PLUGIN_AUTH file to some plugin dir, rename it to EXAMPLE_PLUGIN
// and try to load EXAMPLE_PLUGIN from wrong plugin file.
// The rule - stop looking for plugin file if the first found plugin
// file load fails.
////////////////
call mtr.add_suppression("Can't find symbol 'EXAMPLE' in library");
call mtr.add_suppression("Couldn't load plugin named 'EXAMPLE' with soname");
# restart:--plugin-dir=FAKE_EXAMPLE_PLUGIN_DIR:EXAMPLE_PLUGIN_DIR:PLUGIN_AUTH_DIR PLUGIN_AUTH_LOAD_ADD EXAMPLE_PLUGIN_LOAD_ADD
SELECT @@plugin_dir;
@@plugin_dir
FAKE_EXAMPLE_PLUGIN_DIR/:EXAMPLE_PLUGIN_DIR/:PLUGIN_AUTH_DIR/
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'EXAMPLE';
COUNT(*)
0
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'test_plugin_server';
COUNT(*)
1
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'cleartext_plugin_server';
COUNT(*)
1
////////////////
// test for fake plugin file from 'INSERT PLUGIN' statement
// Copy PLUGIN_AUTH file to some plugin dir, rename it to EXAMPLE_PLUGIN
// and try to load EXAMPLE_PLUGIN from wrong plugin file.
// The rule - stop looking for plugin file if the first found plugin
// file load fails.
////////////////
call mtr.add_suppression("Can't find symbol 'EXAMPLE' in library");
call mtr.add_suppression("Couldn't load plugin named 'EXAMPLE' with soname");
# restart:--plugin-dir=FAKE_EXAMPLE_PLUGIN_DIR:EXAMPLE_PLUGIN_DIR:PLUGIN_AUTH_DIR
SELECT @@plugin_dir;
@@plugin_dir
FAKE_EXAMPLE_PLUGIN_DIR/:EXAMPLE_PLUGIN_DIR/:PLUGIN_AUTH_DIR/
INSTALL PLUGIN example SONAME 'ha_example.so';
ERROR HY000: Can't find symbol 'example' in library
INSTALL PLUGIN test_plugin_server SONAME 'auth_test_plugin.so';
INSTALL PLUGIN cleartext_plugin_server SONAME 'auth_test_plugin.so';
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'EXAMPLE';
COUNT(*)
0
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'test_plugin_server';
COUNT(*)
1
SELECT COUNT(*) FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'cleartext_plugin_server';
COUNT(*)
1
UNINSTALL PLUGIN test_plugin_server;
UNINSTALL PLUGIN cleartext_plugin_server;
