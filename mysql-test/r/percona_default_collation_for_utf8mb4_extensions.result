RESET MASTER;
*** Variables from the default session
*** (values for all collation variables are expected to be utf8mb4_0900_ai_ci)
SHOW GLOBAL VARIABLES LIKE '%collation%';
Variable_name	Value
collation_connection	utf8mb4_0900_ai_ci
collation_database	utf8mb4_0900_ai_ci
collation_server	utf8mb4_0900_ai_ci
default_collation_for_utf8mb4	utf8mb4_0900_ai_ci
SHOW SESSION VARIABLES LIKE '%collation%';
Variable_name	Value
collation_connection	utf8mb4_0900_ai_ci
collation_database	utf8mb4_0900_ai_ci
collation_server	utf8mb4_0900_ai_ci
default_collation_for_utf8mb4	utf8mb4_0900_ai_ci

*** Variables from the new connection established via MySQL command line client
*** (values for all collation variables are expected to be utf8mb4_0900_ai_ci)
Variable_name	Value
collation_connection	utf8mb4_0900_ai_ci
collation_database	utf8mb4_0900_ai_ci
collation_server	utf8mb4_0900_ai_ci
default_collation_for_utf8mb4	utf8mb4_0900_ai_ci
Variable_name	Value
collation_connection	utf8mb4_0900_ai_ci
collation_database	utf8mb4_0900_ai_ci
collation_server	utf8mb4_0900_ai_ci
default_collation_for_utf8mb4	utf8mb4_0900_ai_ci


*** Updating collation variables
SET GLOBAL default_collation_for_utf8mb4 = utf8mb4_general_ci;
Warnings:
Warning	1681	Updating 'default_collation_for_utf8mb4' is deprecated. It will be made read-only in a future release.
SET GLOBAL collation_server = utf8mb4_general_ci;
SET GLOBAL collation_connection = utf8mb4_general_ci;
SET GLOBAL collation_database = utf8mb4_general_ci;
Warnings:
Warning	1681	Updating 'collation_database' is deprecated. It will be made read-only in a future release.


*** Re-connecting


*** Variables after re-connecting to the default database
*** (values for all collation variables except for @@session.collation_database are expected to be utf8mb4_general_ci)
SHOW GLOBAL VARIABLES LIKE '%collation%';
Variable_name	Value
collation_connection	utf8mb4_general_ci
collation_database	utf8mb4_general_ci
collation_server	utf8mb4_general_ci
default_collation_for_utf8mb4	utf8mb4_general_ci
SHOW SESSION VARIABLES LIKE '%collation%';
Variable_name	Value
collation_connection	utf8mb4_general_ci
collation_database	utf8mb4_0900_ai_ci
collation_server	utf8mb4_general_ci
default_collation_for_utf8mb4	utf8mb4_general_ci


*** Creating a fresh database
CREATE DATABASE fresh;
SHOW CREATE DATABASE fresh;
Database	Create Database
fresh	CREATE DATABASE `fresh` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci */ /*!80016 DEFAULT ENCRYPTION='N' */


*** Variables after connecting to a fresh database
*** (values for collation variables expected to be utf8mb4_general_ci)
SHOW GLOBAL VARIABLES LIKE '%collation%';
Variable_name	Value
collation_connection	utf8mb4_general_ci
collation_database	utf8mb4_general_ci
collation_server	utf8mb4_general_ci
default_collation_for_utf8mb4	utf8mb4_general_ci
SHOW SESSION VARIABLES LIKE '%collation%';
Variable_name	Value
collation_connection	utf8mb4_general_ci
collation_database	utf8mb4_general_ci
collation_server	utf8mb4_general_ci
default_collation_for_utf8mb4	utf8mb4_general_ci


*** Variables from the new connection established via MySQL command line client to a fresh database
*** (values for all collation variables are expected to be utf8mb4_general_ci)
Variable_name	Value
collation_connection	utf8mb4_general_ci
collation_database	utf8mb4_general_ci
collation_server	utf8mb4_general_ci
default_collation_for_utf8mb4	utf8mb4_general_ci
Variable_name	Value
collation_connection	utf8mb4_general_ci
collation_database	utf8mb4_general_ci
collation_server	utf8mb4_general_ci
default_collation_for_utf8mb4	utf8mb4_general_ci


*** Creating tables in the fresh database from the default connection
CREATE TABLE t1(id BIGINT UNSIGNED);
SET character_set_client = utf8mb4;
CREATE TABLE t2(id BIGINT UNSIGNED);
SET NAMES DEFAULT;
CREATE TABLE t3(id BIGINT UNSIGNED);
SET NAMES utf8mb4;
CREATE TABLE t4(id BIGINT UNSIGNED);
SET NAMES utf8mb4 COLLATE utf8mb4_general_ci;
CREATE TABLE t5(id BIGINT UNSIGNED);
SET CHARACTER SET DEFAULT;
CREATE TABLE t6(id BIGINT UNSIGNED);
SET CHARACTER SET utf8mb4;
CREATE TABLE t7(id BIGINT UNSIGNED);
SET collation_connection = utf8mb4_general_ci;
CREATE TABLE t8(id BIGINT UNSIGNED);


*** Making sure that binlog events created implicitly via stored procedures
*** and triggers have character_set_client = 45
CREATE TRIGGER test_trigger BEFORE INSERT ON t2 FOR EACH ROW
BEGIN
INSERT INTO t1 SET id = NEW.id;
END|
CREATE PROCEDURE proc()
BEGIN
INSERT INTO t2 VALUES (42);
END|
INSERT INTO t2 VALUES(1);
CALL proc();


*** Creating tables in the fresh database from a connection established via MySQL command line client


*** Creating logical dump of the fresh database


*** Creating a database for restoring data from the logical dump
CREATE DATABASE restore;
SHOW CREATE DATABASE restore;
Database	Create Database
restore	CREATE DATABASE `restore` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci */ /*!80016 DEFAULT ENCRYPTION='N' */


*** Restoring data from the logical dump


*** Checking events in the binary log
include/assert_grep.inc [Events in the binary log must use utf8mb4_general_ci (45) collation]
include/assert_grep.inc [Events in the binary log must not use utf8mb4_0900_ai_ci (255) collation]


*** Dropping fresh database
DROP DATABASE restore;
DROP DATABASE fresh;


*** Restoring collation variables
SET GLOBAL collation_database = utf8mb4_0900_ai_ci;
Warnings:
Warning	1681	Updating 'collation_database' is deprecated. It will be made read-only in a future release.
SET GLOBAL collation_connection = utf8mb4_0900_ai_ci;
SET GLOBAL collation_server = utf8mb4_0900_ai_ci;
SET GLOBAL default_collation_for_utf8mb4 = utf8mb4_0900_ai_ci;
Warnings:
Warning	1681	Updating 'default_collation_for_utf8mb4' is deprecated. It will be made read-only in a future release.
