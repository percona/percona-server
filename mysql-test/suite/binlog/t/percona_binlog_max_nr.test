source include/have_log_bin.inc;
source include/not_embedded.inc;

RESET MASTER;

let $MYSQLD_DATADIR= `select @@datadir`;
let $INDEX=$MYSQLD_DATADIR/master-bin.index;

--echo ##############################################################
--echo testing purge binary logs to max number on explicit FLUSH LOGS
--echo ##############################################################

source include/show_binary_logs.inc;
file_exists $MYSQLD_DATADIR/master-bin.000001;

CREATE TABLE t1 (a int primary key auto_increment, b blob);
--disable_query_log
let $c=20;
begin;
while ($c)
{
  eval INSERT INTO t1 (b) values ('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789');
  dec $c;
}
commit;
--enable_query_log

flush logs;
source include/show_binary_logs.inc;

DROP TABLE t1;

reset master;

--echo ##############################################################
--echo testing purge binary logs to max number on implicit flush
--echo i.e. when starting new file
--echo ##############################################################

source include/show_binary_logs.inc;
file_exists $MYSQLD_DATADIR/master-bin.000001;

CREATE TABLE t1 (a int primary key auto_increment, b blob);
--disable_query_log
let $c=20;
begin;
while ($c)
{
  eval INSERT INTO t1 (b) values ('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789'),('0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789');
  dec $c;
}
commit;
--enable_query_log

source include/show_binary_logs.inc;
DROP TABLE t1;

reset master;

--echo End of tests
