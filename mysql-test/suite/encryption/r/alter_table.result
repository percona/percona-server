#
# WL#12261 Control (enforce and disable) table encryption
#
# Pre-define user u1, which is used in different tests below.
CREATE USER u1@localhost;
GRANT ALL ON db1.* TO u1@localhost;
GRANT CREATE TABLESPACE, PROCESS, SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost;
SET GLOBAL debug= '+d,skip_table_encryption_admin_check_for_set';
# This test run ALTER TABLE in different configurations,
#
# - Setting table_encryption_privilege_check to true/false.
# - Setting default_table_encryption to true/false.
# - With and without user holding TABLE_ENCRYPTION_ADMIN privilege.
# - Test SHOW CREATE TABLE
# - Test INFORMATION_SCHEMA.TABLES.CREATE_OPTIONS
# - Check for warnings generated.
#
# See comments in alter_table.inc for more details.
`````````````````````````````````````````````````````````
# Test using user tablespace 'ts1'
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption OFF
# [ALTER TABLE] Case 1 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 2 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 3 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 4 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 5 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving Master Key encrypted table to Keyring
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 6 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 7 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving Master Key encrypted table to Keyring
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 8 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 9 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption ON
# [ALTER TABLE] Case 10 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 11 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 12 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 13 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 14 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving Master Key encrypted table to Keyring
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 15 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 16 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving Keyring encrypted table to Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 17 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 18 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption OFF
# [ALTER TABLE] Case 19 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Request to create encrypted table to unencrypted database is rejected.
# [ALTER TABLE] Case 20 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 21 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Request to create KEYRING encrypted table to unencrypted database is rejected.
# [ALTER TABLE] Case 22 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 23 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 24 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 25 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving KEYRING encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 26 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# Moving between Master Key encrypted tablespace
# and file_per_table Keyring encrypted tablespace
# is allowed (given ENCRYPTION clause is provided).
# [ALTER TABLE] Case 27 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 28 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption ON
# [ALTER TABLE] Case 29 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 30 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 31 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 32 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 33 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 34 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving Master Key encrypted table to Keyring
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 35 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 36 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted tablespace is rejected.
# [ALTER TABLE] Case 37 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Moving Keyring encrypted table to Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 38 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
# [ALTER TABLE] Case 39 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE ts1 ADD DATAFILE 'ts1.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=ts1 ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=ts1 ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `ts1` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
DROP TABLESPACE ts1;
`````````````````````````````````````````````````````````
# Using 'innodb_system' tablespace not encrypted
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption OFF
# [ALTER TABLE] Case 40 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 41 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	
t3	ENCRYPTION='y'
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 42 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 43 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 44 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 45 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	
t3	ENCRYPTION='keyring'
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a mk encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 46 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted system
# tablespace is rejected.
# [ALTER TABLE] Case 47 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted system
# tablespace is rejected.
# [ALTER TABLE] Case 48 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption ON
# [ALTER TABLE] Case 49 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 50 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='n'
t3	ENCRYPTION='y'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 51 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 52 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 53 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 54 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='n'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a mk encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 55 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted sytem
# tablespace is rejected.
# [ALTER TABLE] Case 56 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Moving encrypted tablespace to unencrypted system
# tablespace is rejected.
# [ALTER TABLE] Case 57 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption OFF
# [ALTER TABLE] Case 58 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create encrypted table to unencrypted database is rejected.
# [ALTER TABLE] Case 59 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 60 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	
t3	ENCRYPTION='y'
t4	
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 61 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 62 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create keyring encrypted table to unencrypted
# database is rejected.
# [ALTER TABLE] Case 63 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# not encrypted system tablespace
# [ALTER TABLE] Case 64 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	
t3	ENCRYPTION='keyring'
t4	
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 65 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected
# in not encrypted system tablespace
# [ALTER TABLE] Case 66 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create encrypted table to unencrypted database is rejected.
# [ALTER TABLE] Case 67 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in not encrypted
# system tablespace.
# [ALTER TABLE] Case 68 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create keyring encrypted table to unencrypted
# database is rejected.
# [ALTER TABLE] Case 69 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in not encrypted
# system tablespace.
# [ALTER TABLE] Case 70 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption ON
# [ALTER TABLE] Case 71 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in
# not encrypted system tablespace.
# [ALTER TABLE] Case 72 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='n'
t3	ENCRYPTION='y'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table under database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 73 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 74 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in not encrypted
# system tablespace
# [ALTER TABLE] Case 75 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in not
# encrypted system tablespace
# [ALTER TABLE] Case 76 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='n'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table under database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 77 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 78 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Source tablespace is encrypted but target tablespace is not.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected
# in system tablespace
# [ALTER TABLE] Case 79 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create encrypted table to
# to unencrypted system tablespace is rejected.
# [ALTER TABLE] Case 80 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in not encrypted
# system tablespace.
# [ALTER TABLE] Case 81 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in not encrypted
# system tablespace.
# [ALTER TABLE] Case 82 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in not encrypted
# system tablespace.
# [ALTER TABLE] Case 83 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 84 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an encrypted table is rejected in not encrypted
# system tablespace.
# [ALTER TABLE] Case 85 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create an 'encrypted' table while using an 'unencrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Using 'innodb_system' tablespace KEYRING encrypted
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
SET GLOBAL innodb_encryption_threads=4;
# Wait max 10 min for key encryption threads to encrypt all spaces
SET GLOBAL innodb_encryption_threads=0;
SET GLOBAL default_table_encryption=OFF;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption OFF
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 86 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 87 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	
t3	ENCRYPTION='y'
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 88 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 89 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 90 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 91 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a mk encrypted table is rejected in
# keyring encrypted system tablespace
# [ALTER TABLE] Case 92 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 93 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 94 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption ON
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 95 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 96 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='n'
t3	ENCRYPTION='y'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 97 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 98 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 99 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 100 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a mk encrypted table is rejected in
# keyring encrypted system tablespace
# [ALTER TABLE] Case 101 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 102 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 103 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption OFF
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 104 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create encrypted table to unencrypted database is rejected.
# [ALTER TABLE] Case 105 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 106 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	
t3	ENCRYPTION='y'
t4	
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 107 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 108 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create keyring encrypted table to unencrypted
# database is rejected.
# [ALTER TABLE] Case 109 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 110 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 111 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 112 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a mk encrypted table is rejected in
# keyring encrypted system tablespace
# [ALTER TABLE] Case 113 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 114 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create a keyring encrypted table to unencrypted
# database is rejected.
# [ALTER TABLE] Case 115 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption ON
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 116 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 117 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='n'
t3	ENCRYPTION='y'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table under database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 118 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 119 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 120 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create keyring encrypted table to master key
# encrypted database is rejected.
# [ALTER TABLE] Case 121 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table under database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 122 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 123 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 124 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 125 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace.
# [ALTER TABLE] Case 126 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Moving Master Key encrypted table to Keyring
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 127 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Source tablespace is Master Key encrypted but target tablespace is Keyring encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# Creating a mk encrypted table is rejected in
# keyring encrypted system tablespace
# [ALTER TABLE] Case 128 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Master Key encrypted table is rejected in
# KEYRING encrypted system tablespace
# [ALTER TABLE] Case 129 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Request to create y encrypted table while using ONLINE_KEYRING encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# Decrypt innodb_system tablespace
SET GLOBAL default_table_encryption=ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
SET GLOBAL innodb_encryption_threads=4;
# Wait max 10 min for key encryption threads to encrypt all spaces
SET GLOBAL innodb_encryption_threads=0;
SET GLOBAL default_table_encryption=OFF;
`````````````````````````````````````````````````````````
# Test using 'innodb_file_per_table'
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption OFF
# [ALTER TABLE] Case 130 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 131 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 132 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 133 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 134 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 135 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 136 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 137 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 138 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption ON
# [ALTER TABLE] Case 139 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 140 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 141 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 142 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 143 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 144 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 145 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 146 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 147 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption OFF
# [ALTER TABLE] Case 148 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create encrypted table to database with default
# encryption=OFF is rejected.
# [ALTER TABLE] Case 149 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 150 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create encrypted table to database with default
# encryption=OFF is rejected.
# [ALTER TABLE] Case 151 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 152 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 153 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 154 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create KEYRING encrypted table to database
# with default encryption=OFF is rejected.
# [ALTER TABLE] Case 155 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 156 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create MASTER KEY encrypted  table to database
# with default encryption=OFF is rejected.
# [ALTER TABLE] Case 157 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 158 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption ON
# [ALTER TABLE] Case 159 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 160 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 161 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table to database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 162 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 163 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 164 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 165 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table to database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 166 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 167 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table to database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 168 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 169 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 170 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 171 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# Cleanup server started by MTR
DROP USER u1@localhost;
SET GLOBAL debug= '-d,skip_table_encryption_admin_check_for_set';
# Here we are going to test Master Key encrypted system tablespace.
# For this we need to bootstap new server, as Master Key encryption
# is bootstrap only option.
# Stop the instance which was created by MTR
# create bootstrap file
# Bootstrap new instance with encrypted system tablespace
# Check Encryption header of ibdata1
# Start the instance with encrypted system tablespace
# restart: --datadir=MYSQLD_DATADIR1 --innodb-sys-tablespace-encrypt=ON
# Pre-define user u1, which is used in different tests below.
CREATE USER u1@localhost;
GRANT ALL ON db1.* TO u1@localhost;
GRANT ALL ON test.* TO u1@localhost;
GRANT CREATE TABLESPACE, PROCESS, SYSTEM_VARIABLES_ADMIN ON *.* TO u1@localhost;
SET GLOBAL debug= '+d,skip_table_encryption_admin_check_for_set';
`````````````````````````````````````````````````````````
# Using 'innodb_system' tablespace Master Key encrypted
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption OFF
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 172 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 173 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 174 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 175 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 176 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 177 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	
t3	ENCRYPTION='keyring'
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
SET GLOBAL innodb_sys_tablespace_encrypt=RE_ENCRYPTING_TO_KEYRING;
# Moving Keyring encrypted table to Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 178 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 179 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 180 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
SET GLOBAL innodb_sys_tablespace_encrypt=ON;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=OFF and default per-db encryption ON
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 181 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 182 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 183 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 184 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 185 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 186 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='n'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
SET GLOBAL innodb_sys_tablespace_encrypt=RE_ENCRYPTING_TO_KEYRING;
`````````````````````````````````````````````````````````
# Moving Keyring encrypted table to Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 187 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 188 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 189 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=false;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
SET GLOBAL innodb_sys_tablespace_encrypt=ON;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption OFF
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 190 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create Master Key encrypted table to
# unencrypted database is rejected.
# [ALTER TABLE] Case 191 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 192 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace.
# [ALTER TABLE] Case 193 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='y'
t3	
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Database privilege check is ignored as we neither
# change the database nor the ENCRYPTION clause.
# [ALTER TABLE] Case 194 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create keyring encrypted table to unencrypted
# database is rejected.
# [ALTER TABLE] Case 195 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	
t3	
t4	
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# Master Key encrypted system tablespace.
# [ALTER TABLE] Case 196 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	
t3	ENCRYPTION='keyring'
t4	
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
SET GLOBAL innodb_sys_tablespace_encrypt=RE_ENCRYPTING_TO_KEYRING;
`````````````````````````````````````````````````````````
# Request to create unencrypted table in Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 197 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	
t2	ENCRYPTION='keyring'
t3	
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# Master Key encrypted system tablespace.
# [ALTER TABLE] Case 198 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Moving Keyring encrypted table to Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 199 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 200 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
SET GLOBAL innodb_sys_tablespace_encrypt=ON;
`````````````````````````````````````````````````````````
# Moving Keyring encrypted table to Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 201 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a keyring encrypted table is rejected in
# Master Key encrypted system tablespace.
# [ALTER TABLE] Case 202 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='n';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# table_encryption_privilege_check=ON and default per-db encryption ON
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 203 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='n'
t3	ENCRYPTION='n'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 204 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table under database with default
# encryption=ON is rejected.
# [ALTER TABLE] Case 205 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 206 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='y'
t3	ENCRYPTION='n'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# [ALTER TABLE] Case 207 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_system` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='y'
t3	ENCRYPTION='y'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating an Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 208 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='n'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='n'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# Creating an keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 209 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='n';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='n';
Warnings:
Warning	3824	Creating an unencrypted table in a database with default encryption enabled.
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='n' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='n'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='n'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Request to create unencrypted table under database with default
# encryption=ON is rejected.
SET GLOBAL innodb_sys_tablespace_encrypt=RE_ENCRYPTING_TO_KEYRING;
# [ALTER TABLE] Case 210 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ERROR HY000: Table encryption differ from its database default encryption, and user doesn't have enough privilege.
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
# Creating an unencrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 211 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='n';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='n';
ERROR HY000: Request to create an 'unencrypted' table while using an 'encrypted' tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='n'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='n'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='n'
t4	ENCRYPTION='keyring'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 212 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Moving Keyring encrypted table to Master Key
# encrypted tablespace is rejected.
# [ALTER TABLE] Case 213 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
SET GLOBAL default_table_encryption=ONLINE_TO_KEYRING;
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd';
SET GLOBAL default_table_encryption=OFF;
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='keyring';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='keyring';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='y';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='y';
ERROR HY000: Source tablespace is Keyring encrypted but target tablespace is Master Key encrypted.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='keyring' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='y'
t2	ENCRYPTION='keyring'
t3	ENCRYPTION='y'
t4	ENCRYPTION='keyring'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
SET GLOBAL innodb_sys_tablespace_encrypt=ON;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 214 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
DROP DATABASE db1;
DROP TABLESPACE tsA;
`````````````````````````````````````````````````````````
# Creating a Keyring encrypted table is rejected in
# Master Key encrypted system tablespace
# [ALTER TABLE] Case 215 )
`````````````````````````````````````````````````````````
CREATE DATABASE db1 DEFAULT ENCRYPTION='y';
CREATE TABLESPACE tsA ADD DATAFILE 'ts_a.ibd' ENCRYPTION='y';
CREATE TABLE db1.t1 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t2 (f1 int) ENCRYPTION='y';
CREATE TABLE db1.t3 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
CREATE TABLE db1.t4 (f1 int) TABLESPACE=tsA ENCRYPTION='y';
# Grant TABLE_ENCRYPTION_ADMIN if requested.
GRANT TABLE_ENCRYPTION_ADMIN ON *.* TO u1@localhost;
SET GLOBAL table_encryption_privilege_check=true;
# Run ALTER TABLE and check for errors/warnings
ALTER TABLE db1.t1 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t2 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
ALTER TABLE db1.t3 TABLESPACE=innodb_file_per_table ENCRYPTION='keyring';
ALTER TABLE db1.t4 TABLESPACE=innodb_system ENCRYPTION='keyring';
ERROR HY000: Request to create keyring encrypted table while using MASTER KEY encrypted tablespace.
SET GLOBAL table_encryption_privilege_check=false;
# Verify the ENCRYPTION clause value.
SHOW CREATE TABLE db1.t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f1` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='y'
SHOW CREATE TABLE db1.t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `innodb_file_per_table` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ENCRYPTION='keyring'
SHOW CREATE TABLE db1.t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `f1` int DEFAULT NULL
) /*!50100 TABLESPACE `tsA` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci /*!80016 ENCRYPTION='y' */
SELECT TABLE_NAME, CREATE_OPTIONS FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_SCHEMA='db1';
TABLE_NAME	CREATE_OPTIONS
t1	ENCRYPTION='keyring'
t2	ENCRYPTION='y'
t3	ENCRYPTION='keyring'
t4	ENCRYPTION='y'
# Cleanup
# REVOKE TABLE_ENCRYPTION_ADMIN from user.
REVOKE TABLE_ENCRYPTION_ADMIN ON *.* FROM u1@localhost;
DROP DATABASE db1;
DROP TABLESPACE tsA;
# Start default MTR instance
# restart
