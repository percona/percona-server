call mtr.add_suppression("\\[InnoDB\\] Tablespace id [0-9]+ in file t1\.ibd is encrypted but keyring or used key_id 4 is not available\. Can't continue reading table\. Please provide the correct keyring\.");
call mtr.add_suppression("\\[InnoDB\\] Tablespace for table `test`\.`t1` is set as discarded\.");
call mtr.add_suppression("\\[InnoDB\\] Cannot calculate statistics for table .* because the \.ibd file is missing\. Please refer to .* for how to resolve the issue\.");
call mtr.add_suppression("\\[InnoDB\\] Encryption can't find tablespace key_id = 4");
CREATE TABLE t1 (pk INT PRIMARY KEY, f VARCHAR(255)) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=4;
SHOW WARNINGS;
Level	Code	Message
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `pk` int NOT NULL,
  `f` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`pk`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=COMPRESSED ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=4
INSERT INTO t1 VALUES (1,'foobar'),(2,'barfoo');
FLUSH TABLE t1 FOR EXPORT;
# List before copying files
t1.cfg
t1.ibd
backup: t1
UNLOCK TABLES;
ALTER TABLE t1 DISCARD TABLESPACE;
restore: t1 .ibd and .cfg files
# restart:--keyring-file-data=MYSQLTEST_VARDIR/keys2.txt
ALTER TABLE t1 IMPORT TABLESPACE;
ERROR HY000: You are importing table that is encrypted but keyring or used key is not available. Can't continue importing this table. Please provide the correct keyring.
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `pk` int NOT NULL,
  `f` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`pk`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=COMPRESSED ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=4
SELECT * FROM t1;
ERROR HY000: Tablespace has been discarded for table 't1'
# Tablespaces should be still encrypted
# t1 yes on expecting NOT FOUND
# restart: --keyring-file-data=MYSQLTEST_VARDIR/keys1.txt
DROP TABLE t1;
