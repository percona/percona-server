SET GLOBAL innodb_file_per_TABLE = ON;
CREATE TABLESPACE ts1 ENCRYPTION_KEY_ID=3;
CREATE TABLE t1_in_ts1 (a VARCHAR(255)) TABLESPACE=ts1;
CREATE TABLESPACE ts2 ENCRYPTION_KEY_ID=5;
CREATE TABLE t1_in_ts2 (a VARCHAR(255)) TABLESPACE=ts2;
CREATE TABLESPACE ts3;
CREATE TABLE t1_in_ts3 (a VARCHAR(255)) TABLESPACE=ts3;
CREATE TABLESPACE ts4 ENCRYPTION='N';
CREATE TABLE t1_in_ts4 (a VARCHAR(255)) TABLESPACE=ts4;
CREATE TABLESPACE ts5 ENCRYPTION='KEYRING';
CREATE TABLE t1_in_ts5 (a VARCHAR(255)) ENCRYPTION='KEYRING' TABLESPACE=ts5;
INSERT t1_in_ts1 VALUES (repeat('foobarsecret', 12));
INSERT t1_in_ts2 VALUES (repeat('tempsecret', 12));
INSERT t1_in_ts3 VALUES (repeat('dummysecret', 12));
INSERT t1_in_ts4 VALUES (repeat('soooosecret', 12));
INSERT t1_in_ts5 VALUES (repeat('secretsecret', 12));
SET GLOBAL default_TABLE_encryption=ONLINE_TO_KEYRING;
SET GLOBAL innodb_encryption_threads=4;
include/assert.inc [TABLE ts4 should not be encrypted]
include/assert.inc [Successful rotation of percona_innodb-0 to version 2]
include/assert.inc [None of the TABLESPACEs should get re-encrypted with version 2]
include/assert.inc [Successful rotation of percona_innodb-0 to version 3]
include/assert.inc [TABLE ts1 should not get re-encrypted as key 3 is still in version 1]
include/assert.inc [TABLESPACE ts2 should not get re-encrypted as key 3 is still in version 1]
include/assert.inc [TABLE ts4 should stay unencrypted]
# Now, let's rotate key 5 twice
include/assert.inc [Successful rotation of percona_innodb-5 to version 2]
include/assert.inc [Successful rotation of percona_innodb-5 to version 3]
CREATE TABLESPACE ts6 ENCRYPTION_KEY_ID=5;
CREATE TABLE t1_in_ts6 (a varchar(255)) TABLESPACE=ts6;
include/assert.inc [TABLESPACE ts6 should be encrypted with latest version of percona_innodb-5, i.e. version 3]
SET GLOBAL innodb_encryption_threads=0;
CREATE TABLESPACE ts7 ENCRYPTION='KEYRING';
CREATE TABLE t1_in_ts7 (a VARCHAR(255)) ENCRYPTION='KEYRING' TABLESPACE=ts7;
include/assert.inc [TABLESPACE ts7 should be encrypted with latest version of percona_innodb-0, i.e. version 3]
SET GLOBAL innodb_encryption_threads=4;
# Setting innodb_encryption_rotate_key_age to 1. Now each key rotation should result
# in re-encryption of the TABLE
SET GLOBAL innodb_encryption_rotate_key_age = 1;
include/assert.inc [Successful rotation of percona_innodb-0 to version 4]
include/assert.inc [TABLE ts2 should not get re-encrypted as key 5 is still in version 3]
# Rotate key 5 to version 4 => this should trigger TABLE ts2 re-encryption
include/assert.inc [Successful rotation of percona_innodb-5 to version 4]
# Now turn the re-encryption off by setting innodb_encryption_rotate_key_age to 0
SET GLOBAL innodb_encryption_rotate_key_age = 0;
# Rotating key should not cause any re-encryption
include/assert.inc [Successful rotation of percona_innodb-0 to version 5]
# Rotate key 5 to version 5 => this should trigger TABLE ts2 re-encryption
include/assert.inc [Successful rotation of percona_innodb-5 to version 5]
include/assert.inc [All TABLEs should be still encrypted with key version 4 at most.]
# Make sure ts4 is still unencrypted
include/assert.inc [TABLESPACE ts4 should stay unencrypted]
# Now turn off the encryption. Only one TABLE should remain encrypted - the one with explicit encryption
# i.e. ts5 and ts7
SET GLOBAL default_TABLE_encryption = ONLINE_FROM_KEYRING_TO_UNENCRYPTED;
SET GLOBAL innodb_encryption_rotate_key_age = 2;
include/assert.inc [TABLESPACE ts5 should be encrypted]
include/assert.inc [TABLESPACE ts7 should be encrypted]
SET GLOBAL default_TABLE_encryption=OFF;
SET GLOBAL innodb_encryption_threads=0;
DROP TABLE t1_in_ts1, t1_in_ts2, t1_in_ts3, t1_in_ts4, t1_in_ts5, t1_in_ts6, t1_in_ts7;
DROP TABLESPACE ts1;
DROP TABLESPACE ts2;
DROP TABLESPACE ts3;
DROP TABLESPACE ts4;
DROP TABLESPACE ts5;
DROP TABLESPACE ts6;
DROP TABLESPACE ts7;
