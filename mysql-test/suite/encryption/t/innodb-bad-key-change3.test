-- source include/not_valgrind.inc

call mtr.add_suppression("\\[InnoDB\\] Tablespace id [0-9]+ in file t1\.ibd is encrypted but keyring or used key_id 4 is not available\. Can't continue reading table\. Please provide the correct keyring\.");
call mtr.add_suppression("\\[InnoDB\\] Tablespace for table `test`\.`t1` is set as discarded\.");
call mtr.add_suppression("\\[InnoDB\\] Cannot calculate statistics for table .* because the \.ibd file is missing\. Please refer to .* for how to resolve the issue\.");
call mtr.add_suppression("\\[InnoDB\\] Encryption can't find tablespace key_id = 4");

CREATE TABLE t1 (pk INT PRIMARY KEY, f VARCHAR(255)) ENGINE=InnoDB ROW_FORMAT=COMPRESSED ENCRYPTION='KEYRING' ENCRYPTION_KEY_ID=4;
SHOW WARNINGS;
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES (1,'foobar'),(2,'barfoo');
let MYSQLD_DATADIR =`SELECT @@datadir`;
FLUSH TABLE t1 FOR EXPORT;
--echo # List before copying files
--list_files $MYSQLD_DATADIR/test
perl;
do "$ENV{MYSQL_TEST_DIR}/include/innodb-util.inc";
ib_backup_tablespaces("test", "t1");
EOF
UNLOCK TABLES;

ALTER TABLE t1 DISCARD TABLESPACE;

perl;
do "$ENV{MYSQL_TEST_DIR}/include/innodb-util.inc";
ib_discard_tablespaces("test", "t1");
ib_restore_tablespaces("test", "t1");
EOF

--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters=restart:--keyring-file-data=$MYSQLTEST_VARDIR/keys2.txt
--source include/restart_mysqld.inc

--let MYSQLD_DATADIR =`SELECT @@datadir`
--let t1_IBD = $MYSQLD_DATADIR/test/t1.ibd

--error ER_IMPORT_TABLESPACE_MISSING_KEY
ALTER TABLE t1 IMPORT TABLESPACE;
SHOW CREATE TABLE t1;
--error ER_TABLESPACE_DISCARDED
SELECT * FROM t1;
--echo # Tablespaces should be still encrypted

--let SEARCH_PATTERN=foobar
--let ABORT_ON=FOUND
--echo # t1 yes on expecting NOT FOUND
--let SEARCH_FILE=$t1_IBD
--source include/search_pattern_in_file.inc

--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--let $restart_parameters=restart: --keyring-file-data=$MYSQLTEST_VARDIR/keys1.txt
--source include/restart_mysqld.inc

DROP TABLE t1;

# reset system

--remove_file $MYSQLTEST_VARDIR/keys1.txt
--remove_file $MYSQLTEST_VARDIR/keys2.txt
