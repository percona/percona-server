#
# Bug#31313533 : IMPORT FAILS FOR ENCRYPT AND COMPRESSION ENABLED TDE TABLES
# upgrade section
#

# Test 4 : check table from old version are read correctly after upgrade

# Stop the running the server
# Copy and unzip the datadir.
# Restart the server against the unzipped datadir
# restart: --datadir=DATADIR --innodb-page-size=16k --early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=DATADIR/keyring KEYRING_PLUGIN_OPT
# Verify tables after upgrade
USE test;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `c1` int(11) NOT NULL AUTO_INCREMENT,
  `c2` varchar(65000) DEFAULT NULL,
  `c3` varchar(255) GENERATED ALWAYS AS (substr(`c2`,2,100)) STORED,
  `c4` varchar(255) GENERATED ALWAYS AS (substr(`c2`,10,200)) VIRTUAL,
  `b` bit(64) DEFAULT NULL,
  `p_c1` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=56000 DEFAULT CHARSET=latin1 COMPRESSION='zlib' ENCRYPTION='Y'
SELECT c1, HEX(SUBSTRING(c2, 10, 10)), HEX(SUBSTRING(c3, 10, 10)), HEX(SUBSTRING(c4, 10, 10)), HEX(b) FROM t1 ORDER BY c1 limit 10;
c1	HEX(SUBSTRING(c2, 10, 10))	HEX(SUBSTRING(c3, 10, 10))	HEX(SUBSTRING(c4, 10, 10))	HEX(b)
50001	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50002	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50003	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50004	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50005	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50006	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50007	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50008	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50009	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50010	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
# Run some DML statements
INSERT INTO t1(c2,b,p_c1) VALUES(AES_ENCRYPT("5dd0786a3c7adf503202b8e234a95cbe643bc752028e1792ca8e6ef86c69582eb1cc478670c8e5d6c0133d1b4e5c98017aeb893f9db5f1bff397bc9e0f5fde48","abc"),10,100);
DELETE FROM t1 WHERE c1=50001;
# Verify results
SELECT c1, HEX(SUBSTRING(c2, 10, 10)), HEX(SUBSTRING(c3, 10, 10)), HEX(SUBSTRING(c4, 10, 10)), HEX(b) FROM t1 ORDER BY c1 limit 10;
c1	HEX(SUBSTRING(c2, 10, 10))	HEX(SUBSTRING(c3, 10, 10))	HEX(SUBSTRING(c4, 10, 10))	HEX(b)
50002	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50003	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50004	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50005	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50006	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50007	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50008	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50009	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50010	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
50011	066C8ADC3EC72175CA77	6C8ADC3EC72175CA77CE	77CEF1FBCA5BFE739000	A
# Cleanup
DROP TABLE t1;
# restart
# Remove copied files
