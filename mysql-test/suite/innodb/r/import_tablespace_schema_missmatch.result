#
# Bug #30190227 CRASH IMPORTING TABLESPACE WITH DIFFERENT DATA DIRECTORY
# BUT NOT .CFG FILE
#
# Test-case-1
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY) DATA DIRECTORY='MYSQL_TMP_DIR/alt_dir';
INSERT INTO t1 VALUES (1), (2), (3);
FLUSH TABLES t1 FOR EXPORT;
UNLOCK TABLES;
DROP TABLE t1;
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY);
ALTER TABLE t1 DISCARD TABLESPACE;
ALTER TABLE t1 IMPORT TABLESPACE;
Warnings:
Warning	1810	InnoDB: IO Read error: (2, No such file or directory) Error opening './test/t1.cfg', will attempt to import without schema verification
DROP TABLE t1;
#
# Test-case-2
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY);
INSERT INTO t1 VALUES (1), (2), (3);
FLUSH TABLES t1 FOR EXPORT;
UNLOCK TABLES;
DROP TABLE t1;
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY) DATA DIRECTORY='MYSQL_TMP_DIR/alt_dir';
SELECT * from t1;
id
ALTER TABLE t1 DISCARD TABLESPACE;
ALTER TABLE t1 IMPORT TABLESPACE;
SELECT * FROM t1;
id
1
2
3
DROP TABLE t1;
#
# Bug #30190199 ERROR WHEN IMPORTING TABLESPACE WITH DIFFERENT DATA
# DIRECTORY LACKS DETAILS
#
# Test-case-3
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY) DATA DIRECTORY='MYSQL_TMP_DIR/alt_dir';
INSERT INTO t1 VALUES (1), (2), (3);
FLUSH TABLES t1 FOR EXPORT;
UNLOCK TABLES;
DROP TABLE t1;
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY);
ALTER TABLE t1 DISCARD TABLESPACE;
ALTER TABLE t1 IMPORT TABLESPACE;
DROP TABLE t1;
#
# Test-case-4
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY);
INSERT INTO t1 VALUES (1), (2), (3);
FLUSH TABLES t1 FOR EXPORT;
UNLOCK TABLES;
DROP TABLE t1;
CREATE TABLE t1 (id int unsigned NOT NULL PRIMARY KEY) DATA DIRECTORY='MYSQL_TMP_DIR/alt_dir';
ALTER TABLE t1 DISCARD TABLESPACE;
ALTER TABLE t1 IMPORT TABLESPACE;
DROP TABLE t1;
#
# Cleanup
#
#
# Bug 76142: InnoDB tablespace import fails when importing table w/ different data directory
#
CREATE TABLE t1 (a INT PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1);
CREATE TABLE t2 (a INT PRIMARY KEY) ENGINE=InnoDB DATA DIRECTORY='MYSQL_TMP_DIR';
INSERT INTO t2 VALUES (3);
FLUSH TABLE t2 FOR EXPORT;
UNLOCK TABLES;
ALTER TABLE t2 DISCARD TABLESPACE;
FLUSH TABLE t1 FOR EXPORT;
UNLOCK TABLES;
ALTER TABLE t2 IMPORT TABLESPACE;
INSERT INTO t2 VALUES (2);
ALTER TABLE t1 DISCARD TABLESPACE;
ALTER TABLE t1 IMPORT TABLESPACE;
INSERT INTO t1 VALUES (4);
SELECT * FROM t1;
a
3
4
SELECT * FROM t2;
a
1
2
DROP TABLE t1, t2;
