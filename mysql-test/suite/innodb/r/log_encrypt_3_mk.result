<<<<<<< HEAD:mysql-test/suite/innodb/r/log_encrypt_3_mk.result
call mtr.add_suppression("ibd can't be decrypted, please confirm the keyfile is match and keyring plugin is loaded.");
call mtr.add_suppression("Encryption can't find master key, please check the keyring plugin is loaded.");
call mtr.add_suppression("Redo log cannot be encrypted if the keyring plugin is not loaded.");
call mtr.add_suppression("Check keyring plugin fail, please check the keyring plugin is loaded.");
call mtr.add_suppression("Redo log key generation failed.");
||||||| ea7d2e2d16a:mysql-test/suite/innodb/r/log_encrypt_3.result
DROP DATABASE IF EXISTS tde_db;
=======
>>>>>>> mysql-8.0.20:mysql-test/suite/innodb/r/log_encrypt_3.result
CREATE DATABASE tde_db;
USE tde_db;
<<<<<<< HEAD:mysql-test/suite/innodb/r/log_encrypt_3_mk.result
SET GLOBAL innodb_redo_log_encrypt = MASTER_KEY;
Warnings:
Warning	7013	InnoDB: Redo log cannot be encrypted if the keyring plugin is not loaded.
SHOW WARNINGS;
Level	Code	Message
Warning	7013	InnoDB: Redo log cannot be encrypted if the keyring plugin is not loaded.
CREATE TABLE tde_db.t4 (a BIGINT PRIMARY KEY, b LONGBLOB) ENGINE=InnoDB;
INSERT INTO t4 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
1	aaaaaaaaaa
# restart
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
1	aaaaaaaaaa
DROP TABLE tde_db.t4;
DROP DATABASE tde_db;
CREATE DATABASE tde_db;
USE tde_db;
# Starting server with keyring plugin
SELECT @@global.innodb_redo_log_encrypt;
||||||| ea7d2e2d16a:mysql-test/suite/innodb/r/log_encrypt_3.result
SET GLOBAL innodb_redo_log_encrypt = 1;
SHOW WARNINGS;
Level	Code	Message
CREATE TABLE tde_db.t4 (a BIGINT PRIMARY KEY, b LONGBLOB) ENGINE=InnoDB;
INSERT INTO t4 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
1	aaaaaaaaaa
# restart
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
1	aaaaaaaaaa
DROP TABLE tde_db.t4;
DROP DATABASE IF EXISTS tde_db;
CREATE DATABASE tde_db;
USE tde_db;
# Starting server with keyring plugin
# restart: --early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/my_key_log3 --plugin-dir=KEYRING_PLUGIN_PATH --innodb_redo_log_encrypt=ON 
SELECT @@global.innodb_redo_log_encrypt ;
=======
SELECT @@global.innodb_redo_log_encrypt ;
>>>>>>> mysql-8.0.20:mysql-test/suite/innodb/r/log_encrypt_3.result
@@global.innodb_redo_log_encrypt
MASTER_KEY
INSTALL PLUGIN keyring_file SONAME 'keyring_file.so';
ERROR HY000: Function 'keyring_file' already exists
UNINSTALL PLUGIN keyring_file;
<<<<<<< HEAD:mysql-test/suite/innodb/r/log_encrypt_3_mk.result
# Starting server with keyring plugin
SET GLOBAL innodb_redo_log_encrypt = 0;
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
OFF
INSTALL PLUGIN keyring_file SONAME 'keyring_file.so';
ERROR HY000: Function 'keyring_file' already exists
UNINSTALL PLUGIN keyring_file;
SELECT @@global.innodb_redo_log_encrypt;
||||||| ea7d2e2d16a:mysql-test/suite/innodb/r/log_encrypt_3.result
# Starting server with keyring plugin
# restart: --early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/my_key_log3 --plugin-dir=KEYRING_PLUGIN_PATH --innodb_redo_log_encrypt=ON 
SET GLOBAL innodb_redo_log_encrypt = 0;
SELECT @@global.innodb_redo_log_encrypt ;
@@global.innodb_redo_log_encrypt
0
INSTALL PLUGIN keyring_file SONAME 'keyring_file.so';
ERROR HY000: Function 'keyring_file' already exists
UNINSTALL PLUGIN keyring_file;
# restart: --early-plugin-load=keyring_file=keyring_file.so --loose-keyring_file_data=MYSQL_TMP_DIR/my_key_log3 --plugin-dir=KEYRING_PLUGIN_PATH --innodb_redo_log_encrypt=ON  
SELECT @@global.innodb_redo_log_encrypt ;
=======
# restart:
SELECT @@global.innodb_redo_log_encrypt ;
>>>>>>> mysql-8.0.20:mysql-test/suite/innodb/r/log_encrypt_3.result
@@global.innodb_redo_log_encrypt
MASTER_KEY
SET GLOBAL innodb_redo_log_encrypt = MASTER_KEY;
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
MASTER_KEY
CREATE TABLE tde_db.t1 (a BIGINT PRIMARY KEY, b LONGBLOB) ENGINE=InnoDB;
INSERT INTO t1 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t1;
a	LEFT(b,10)
1	aaaaaaaaaa
CREATE TABLE tde_db.t2 (a BIGINT PRIMARY KEY, b LONGBLOB)
ENCRYPTION='Y' ENGINE=InnoDB;
INSERT INTO t2 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t2;
a	LEFT(b,10)
1	aaaaaaaaaa
SET GLOBAL innodb_redo_log_encrypt = 0;
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
OFF
CREATE TABLE tde_db.t3 (a BIGINT PRIMARY KEY, b LONGBLOB) ENGINE=InnoDB;
INSERT INTO t3 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t3;
a	LEFT(b,10)
1	aaaaaaaaaa
CREATE TABLE tde_db.t4 (a BIGINT PRIMARY KEY, b LONGBLOB)
ENCRYPTION='Y' ENGINE=InnoDB;
INSERT INTO t4 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
1	aaaaaaaaaa
FLUSH LOGS;
<<<<<<< HEAD:mysql-test/suite/innodb/r/log_encrypt_3_mk.result
||||||| ea7d2e2d16a:mysql-test/suite/innodb/r/log_encrypt_3.result
SELECT
PLUGIN_NAME, PLUGIN_STATUS, PLUGIN_TYPE
FROM INFORMATION_SCHEMA.PLUGINS
WHERE PLUGIN_NAME LIKE '%keyring_file%' ;
PLUGIN_NAME	PLUGIN_STATUS	PLUGIN_TYPE
keyring_file	ACTIVE	KEYRING
=======
# restart:
SELECT
PLUGIN_NAME, PLUGIN_STATUS, PLUGIN_TYPE
FROM INFORMATION_SCHEMA.PLUGINS
WHERE PLUGIN_NAME LIKE '%keyring_file%' ;
PLUGIN_NAME	PLUGIN_STATUS	PLUGIN_TYPE
keyring_file	ACTIVE	KEYRING
>>>>>>> mysql-8.0.20:mysql-test/suite/innodb/r/log_encrypt_3.result
SELECT a,LEFT(b,10) FROM tde_db.t1;
a	LEFT(b,10)
1	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t2;
a	LEFT(b,10)
1	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t3;
a	LEFT(b,10)
1	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
1	aaaaaaaaaa
DROP TABLE tde_db.t1,tde_db.t2,tde_db.t3,tde_db.t4;
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
OFF
CREATE TABLE tde_db.t1 (a BIGINT PRIMARY KEY, b LONGBLOB) ENGINE=InnoDB;
CREATE TABLE tde_db.t2 (a BIGINT PRIMARY KEY, b LONGBLOB)
ENCRYPTION='Y' ENGINE=InnoDB;
START TRANSACTION;
SET GLOBAL innodb_redo_log_encrypt = MASTER_KEY;
INSERT INTO t1 (a, b) VALUES (1, REPEAT('a', 6*512*512));
INSERT INTO t2 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t1;
a	LEFT(b,10)
1	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t2;
a	LEFT(b,10)
1	aaaaaaaaaa
ROLLBACK;
START TRANSACTION;
INSERT INTO t1 (a, b) VALUES (2, REPEAT('a', 6*512*512));
INSERT INTO t2 (a, b) VALUES (2, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t1;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t2;
a	LEFT(b,10)
2	aaaaaaaaaa
COMMIT;
CREATE TABLE tde_db.t3 (a BIGINT PRIMARY KEY, b LONGBLOB) ENGINE=InnoDB;
CREATE TABLE tde_db.t4 (a BIGINT PRIMARY KEY, b LONGBLOB)
ENCRYPTION='Y' ENGINE=InnoDB;
START TRANSACTION;
SET GLOBAL innodb_redo_log_encrypt = 0;
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
OFF
INSERT INTO t3 (a, b) VALUES (1, REPEAT('a', 6*512*512));
INSERT INTO t4 (a, b) VALUES (1, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t3;
a	LEFT(b,10)
1	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
1	aaaaaaaaaa
ROLLBACK;
START TRANSACTION;
INSERT INTO t3 (a, b) VALUES (2, REPEAT('a', 6*512*512));
INSERT INTO t4 (a, b) VALUES (2, REPEAT('a', 6*512*512));
SELECT a,LEFT(b,10) FROM tde_db.t3;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
2	aaaaaaaaaa
COMMIT;
<<<<<<< HEAD:mysql-test/suite/innodb/r/log_encrypt_3_mk.result
# Kill and restart:<hidden args>
||||||| ea7d2e2d16a:mysql-test/suite/innodb/r/log_encrypt_3.result
=======
# restart:
>>>>>>> mysql-8.0.20:mysql-test/suite/innodb/r/log_encrypt_3.result
SELECT
PLUGIN_NAME, PLUGIN_STATUS, PLUGIN_TYPE
FROM INFORMATION_SCHEMA.PLUGINS
WHERE PLUGIN_NAME LIKE '%keyring_file%';
PLUGIN_NAME	PLUGIN_STATUS	PLUGIN_TYPE
keyring_file	ACTIVE	KEYRING
SELECT a,LEFT(b,10) FROM tde_db.t1;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t2;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t3;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
2	aaaaaaaaaa
SET GLOBAL innodb_redo_log_encrypt = 0;
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
OFF
ALTER INSTANCE ROTATE INNODB MASTER KEY;
SELECT a,LEFT(b,10) FROM tde_db.t1;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t2;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t3;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
2	aaaaaaaaaa
SET GLOBAL innodb_redo_log_encrypt = MASTER_KEY;
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
MASTER_KEY
ALTER INSTANCE ROTATE INNODB MASTER KEY;
SELECT a,LEFT(b,10) FROM tde_db.t1;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t2;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t3;
a	LEFT(b,10)
2	aaaaaaaaaa
SELECT a,LEFT(b,10) FROM tde_db.t4;
a	LEFT(b,10)
2	aaaaaaaaaa
CREATE USER encryptnonprivuser@localhost IDENTIFIED BY 'noauth';
GRANT SELECT ON *.* to encryptnonprivuser@localhost;
FLUSH PRIVILEGES;
# In connection 1 - with encryptnonprivuser
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
MASTER_KEY
SET GLOBAL innodb_redo_log_encrypt = 0;
ERROR 42000: Access denied; you need (at least one of) the SUPER or SYSTEM_VARIABLES_ADMIN privilege(s) for this operation
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
MASTER_KEY
SET GLOBAL innodb_redo_log_encrypt = MASTER_KEY;
ERROR 42000: Access denied; you need (at least one of) the SUPER or SYSTEM_VARIABLES_ADMIN privilege(s) for this operation
SELECT @@global.innodb_redo_log_encrypt;
@@global.innodb_redo_log_encrypt
MASTER_KEY
# In connection default
DROP TABLE tde_db.t1,tde_db.t2,tde_db.t3,tde_db.t4;
