--source include/have_rocksdb.inc

# 
# Basic syntax related to primary keys 
#

CREATE TABLE t1 (a INT PRIMARY KEY,
  b CHAR(8)
) ENGINE=ROCKSDB;

--replace_column 7 #
SHOW KEYS IN t1;

INSERT INTO t1 (a,b) VALUES (1,'a'),(2,'b');
--error ER_DUP_ENTRY
INSERT INTO t1 (a,b) VALUES (1,'c');

DROP TABLE t1;

--error ER_MULTIPLE_PRI_KEY
CREATE TABLE t1 (a INT PRIMARY KEY,
  b CHAR(8) PRIMARY KEY
) ENGINE=ROCKSDB;

CREATE TABLE t1 (a INT,
  b CHAR(8),
  PRIMARY KEY (a,b)
) ENGINE=ROCKSDB;

--replace_column 7 #
SHOW INDEX IN t1;
INSERT INTO t1 (a,b) VALUES (1,'a'),(1,'b'),(2,'a'),(2,'b');
--error ER_DUP_ENTRY
INSERT INTO t1 (a,b) VALUES (1,'b');
  DROP TABLE t1;

# KEY in a column definition means PK!

CREATE TABLE t1 (a INT KEY,
  b CHAR(8),
  KEY (b)
) ENGINE=ROCKSDB;

--replace_column 7 #
SHOW INDEX IN t1;
DROP TABLE t1;

CREATE TABLE t1 (a INT,
  b CHAR(8) PRIMARY KEY
) ENGINE=ROCKSDB;

--replace_column 7 #
SHOW INDEX IN t1;

--error ER_MULTIPLE_PRI_KEY
ALTER TABLE t1 ADD CONSTRAINT PRIMARY KEY pk (a);
--replace_column 7 #
SHOW KEYS IN t1;
DROP TABLE t1;

#
# Test index prefix length limits.
#
set @orig_rocksdb_large_prefix=@@global.rocksdb_large_prefix;
set @orig_rocksdb_xlarge_prefix=@@global.rocksdb_xlarge_prefix;
set @@global.rocksdb_large_prefix=0;
set @@global.rocksdb_xlarge_prefix=0;

CREATE TABLE t1 (
  a BLOB(1024),
  PRIMARY KEY (a(767))
) ENGINE=ROCKSDB;
DROP TABLE t1;

--error ER_TOO_LONG_KEY
CREATE TABLE t1 (
  a BLOB(1024),
  PRIMARY KEY (a(768))
) ENGINE=ROCKSDB;

set @@global.rocksdb_large_prefix=1;
set @@global.rocksdb_xlarge_prefix=0;

CREATE TABLE t1 (
  a BLOB(4096),
  PRIMARY KEY (a(3072))
) ENGINE=ROCKSDB;
DROP TABLE t1;

--error ER_TOO_LONG_KEY
CREATE TABLE t1 (
  a BLOB(4096),
  PRIMARY KEY (a(3073))
) ENGINE=ROCKSDB;

set @@global.rocksdb_large_prefix=@orig_rocksdb_large_prefix;

set @@global.rocksdb_xlarge_prefix=1;

CREATE TABLE t1 (
    a BLOB(4096),
PRIMARY KEY (a(4000))
) ENGINE=ROCKSDB;
DROP TABLE t1;

--error ER_TOO_LONG_KEY
CREATE TABLE t1 (
  a BLOB(65535),
  PRIMARY KEY (a(49153))
) ENGINE=ROCKSDB;

set @@global.rocksdb_xlarge_prefix=@orig_rocksdb_xlarge_prefix;
