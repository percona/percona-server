include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
[connection master]
[connection slave]
SET @saved_slave_rows_search_algorithms= @@global.slave_rows_search_algorithms;
[connection master]
SET SQL_LOG_BIN=0;
CREATE TABLE `queries` (id VARCHAR(10), query VARCHAR(255));
SET SQL_LOG_BIN=1;
CREATE FUNCTION update_and_delete_some_rows () RETURNS INT
BEGIN
UPDATE t1 SET field1 = "row1-updated" WHERE field1 = "row1";
DELETE FROM t1 where field1="row2";
RETURN 0;
END|
include/sync_slave_sql_with_master.inc
[connection master]

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 char(15));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1;
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 char(15)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 char(15));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1;;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 char(15));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL AUTO_INCREMENT PRIMARY KEY;
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 char(15)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 char(15));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL AUTO_INCREMENT PRIMARY KEY;;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 char(15));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1, ADD PRIMARY KEY (field1, extra_col);
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 char(15)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 char(15));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1, ADD PRIMARY KEY (field1, extra_col);;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col
row1-updated	1
row3	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 char(15));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col1 INT NOT NULL DEFAULT 100, ADD COLUMN extra_col2 INT NOT NULL AUTO_INCREMENT, ADD PRIMARY KEY (extra_col2);
# columns to be mased: extra_col1, extra_col2
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 char(15)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 char(15));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col1 INT NOT NULL DEFAULT 100, ADD COLUMN extra_col2 INT NOT NULL AUTO_INCREMENT, ADD PRIMARY KEY (extra_col2);;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col1	extra_col2
row1-updated	100	1
row3	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col1	extra_col2
row1-updated	100	1
row3	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col1	extra_col2
row1-updated	100	1
row3	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col1	extra_col2
row1-updated	100	1
row3	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col1	extra_col2
row1-updated	100	1
row3	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col1	extra_col2
row1-updated	100	1
row3	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1
row1-updated
row3
[connection slave]
SELECT * FROM t1;
field1	extra_col1	extra_col2
row1-updated	100	1
row3	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1;
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1;;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL AUTO_INCREMENT PRIMARY KEY;
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL AUTO_INCREMENT PRIMARY KEY;;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1, ADD PRIMARY KEY (field1, extra_col);
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1, ADD PRIMARY KEY (field1, extra_col);;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col1 INT NOT NULL DEFAULT 100, ADD COLUMN extra_col2 INT NOT NULL AUTO_INCREMENT, ADD PRIMARY KEY (extra_col2);
# columns to be mased: extra_col1, extra_col2
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col1 INT NOT NULL DEFAULT 100, ADD COLUMN extra_col2 INT NOT NULL AUTO_INCREMENT, ADD PRIMARY KEY (extra_col2);;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1;
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1;;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL AUTO_INCREMENT PRIMARY KEY;
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL AUTO_INCREMENT PRIMARY KEY;;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1, ADD PRIMARY KEY (field1, extra_col);
# columns to be mased: extra_col
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col INT NOT NULL DEFAULT 1, ADD PRIMARY KEY (field1, extra_col);;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col
row1-updated	1010	1
row3	1010	1
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;

##############################################
# Testing with:
# CREATE_QUERY: CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));
# INSERT_QUERY: INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');
# ALTER_QUERY: ALTER TABLE t1 ADD COLUMN extra_col1 INT NOT NULL DEFAULT 100, ADD COLUMN extra_col2 INT NOT NULL AUTO_INCREMENT, ADD PRIMARY KEY (extra_col2);
# columns to be mased: extra_col1, extra_col2
##############################################
#
# 1. Execute CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2)); on source server.
#
[connection master]
CREATE TABLE t1 (field1 CHAR(15), field2 INT DEFAULT 1010, KEY idx (field1, field2));;
#
# 2. Sync the replica server with source server.
#
include/sync_slave_sql_with_master.inc
#
# 3. Execute ALTER TABLE on replica server.
#
ALTER TABLE t1 ADD COLUMN extra_col1 INT NOT NULL DEFAULT 100, ADD COLUMN extra_col2 INT NOT NULL AUTO_INCREMENT, ADD PRIMARY KEY (extra_col2);;
#
# 4. Test with all combinations of slave_rows_search_algorithms.
#
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN';

# Testing with HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN';

# Testing with TABLE_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'INDEX_SCAN';

# Testing with INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN';

# Testing with TABLE_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,INDEX_SCAN';

# Testing with INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
SET GLOBAL slave_rows_search_algorithms= 'HASH_SCAN,TABLE_SCAN,INDEX_SCAN';

# Testing with TABLE_SCAN,INDEX_SCAN,HASH_SCAN
#
[connection master]
INSERT INTO t1(field1) VALUES ('row1'); INSERT INTO t1(field1) VALUES ('row2'); INSERT INTO t1(field1) VALUES ('row3');;
include/sync_slave_sql_with_master.inc
[connection master]
SELECT update_and_delete_some_rows();
update_and_delete_some_rows()
0
include/sync_slave_sql_with_master.inc
include/assert.inc [There are exactly 2 rows on replica server]
include/diff_tables.inc [master:t1, slave:t1]
[connection master]
SELECT * FROM t1;
field1	field2
row1-updated	1010
row3	1010
[connection slave]
SELECT * FROM t1;
field1	field2	extra_col1	extra_col2
row1-updated	1010	100	1
row3	1010	100	3
[connection master]
TRUNCATE TABLE t1;
include/sync_slave_sql_with_master.inc
#
# 5. Cleanup
#
[connection master]
DROP TABLE t1;
[connection master]
DROP FUNCTION update_and_delete_some_rows;
SET SQL_LOG_BIN=0;
DROP TABLE queries;
SET SQL_LOG_BIN=1;
[connection slave]
SET GLOBAL slave_rows_search_algorithms= @saved_slave_rows_search_algorithms;
include/rpl_end.inc
