#
# Testcase for bug 85158.
#
--source include/not_group_replication_plugin.inc

--let $rpl_multi_source= 1
--let $rpl_topology= 1->2,2->3,1->3
--source include/rpl/init.inc

# MI writes threshold, if the difference between the count of writes to
# the MI repository before and after the actions is greater than the
# threshold, the test failed
--let $threshold=5

# The number of inserts on server_1, if the bug is not fixed the amount
# of the MI repository writes will be greater or equal to this value
--let $inserts_number=50

--echo ###
--echo # STOP REPLICA ON 2
--echo ######
--let $rpl_connection_name= server_2
--source include/connection.inc
STOP REPLICA;

--echo ###
--echo # CREATE TABLE AND INSERTS ON 1
--echo ######
--let $rpl_connection_name= server_1
--source include/connection.inc
CREATE TABLE t1(f1 INT, f2 BLOB);
--disable_query_log
--let $j=$inserts_number
while($j)
{
--eval INSERT INTO t1(f1) VALUES($j)
--dec $j
}
--enable_query_log

--echo ###
--echo # SYNC 1->3
--echo ######
--let $sync_slave_connection= server_3
--source include/rpl/sync_to_replica.inc

--echo ###
--echo # MEASURE 3
--echo ######
STOP REPLICA;
UPDATE performance_schema.setup_objects
  SET enabled='yes', timed='yes'
  WHERE object_schema='mysql';
START REPLICA;

let $before=
`SELECT count_write
  FROM performance_schema.table_io_waits_summary_by_table
  WHERE object_schema='mysql' AND object_name ='slave_master_info'`;

--echo ###
--echo # START REPLICA 2
--echo ######
--let $rpl_connection_name= server_2
--source include/connection.inc
START REPLICA;

--echo ###
--echo # SYNC 1->2,2->3
--echo ######
--let $rpl_connection_name= server_1
--source include/connection.inc
--let $sync_slave_connection= server_2
--source include/rpl/sync_to_replica.inc
--let $sync_slave_connection= server_3
--source include/rpl/sync_to_replica.inc

--echo ###
--echo # MEASURE 3
--echo ######
let $after=
`SELECT count_write
  FROM performance_schema.table_io_waits_summary_by_table
  WHERE object_schema='mysql' AND object_name ='slave_master_info'`;

--echo ###
--echo # COMPARE THE MEASUREMENT RESULTS
--echo ######
--let $result=`SELECT (($after - $before) < $threshold)`
--let $assert_text= No more than $threshold writes should have happened to slave_master_info
--let $assert_cond= $result = 1
--source include/assert.inc

--echo ###
--echo # CLEANUP
--echo ######
UPDATE performance_schema.setup_objects
  SET enabled='no', timed='no'
  WHERE object_schema='mysql';
--let $rpl_connection_name= server_1
--source include/connection.inc
DROP TABLE t1;
--disable_query_log
--let $rpl_skip_sync= 1
--source include/rpl/deinit.inc
--enable_query_log
