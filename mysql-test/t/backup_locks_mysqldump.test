########################################################################
# mysqldump --lock-for-backup tests
########################################################################

--source include/have_log_bin.inc
--source include/have_innodb.inc
--source include/not_embedded.inc

SHOW VARIABLES LIKE 'have_backup_locks';

CREATE TABLE t1 (a INT) ENGINE=InnoDB;
CREATE TABLE t2 (a INT) ENGINE=MyISAM;

SET @old_general_log = @@general_log;
SET @old_log_output = @@log_output;

TRUNCATE TABLE mysql.general_log;

SET GLOBAL log_output = 'TABLE';
SET GLOBAL general_log = ON;

--let $file=$MYSQLTEST_VARDIR/tmp/dump.sql

--error 1
--exec $MYSQL_DUMP --lock-for-backup --lock-all-tables >$file

--echo # Check that --lock-for-backup is converted to --lock-all-tables if
--echo # --single-transaction is not specified

--exec $MYSQL_DUMP --lock-for-backup test >$file

SELECT argument FROM mysql.general_log WHERE argument != '';

TRUNCATE TABLE mysql.general_log;

--echo # Check that --lock-for-backup --single-transaction uses LOCK TABLES FOR
--echo # BACKUP

--exec $MYSQL_DUMP --lock-for-backup --single-transaction test >$file

SELECT argument FROM mysql.general_log WHERE argument != '';

TRUNCATE TABLE mysql.general_log;

--echo # Check that --master-data does not disable --lock-for-backup

--exec $MYSQL_DUMP --lock-for-backup --single-transaction --master-data test >$file

SELECT argument FROM mysql.general_log WHERE argument != '';

TRUNCATE TABLE mysql.general_log;

--remove_file $file

SET GLOBAL log_output = @old_log_output;
SET GLOBAL general_log = @old_general_log;

DROP TABLE t1, t2;
