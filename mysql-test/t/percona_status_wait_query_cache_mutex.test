--source include/have_query_cache.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc
SET GLOBAL query_cache_size=1355776;
--source include/percona_query_cache_with_comments_clear.inc

--source include/count_sessions.inc

--connect (mutex_locked_conn, localhost, root,,)
--connect (try_mutex_lock_conn, localhost, root,,)
--let $try_mutex_lock_conn_id= `SELECT CONNECTION_ID()`

--connection mutex_locked_conn
SET DEBUG_SYNC='after_query_cache_mutex SIGNAL mutex_locked WAIT_FOR unlock_mutex';
send SELECT "mutex_locked_query" as action;

--connection default
SET DEBUG_SYNC='now WAIT_FOR mutex_locked';

--connection try_mutex_lock_conn
SET DEBUG_SYNC='before_query_cache_mutex SIGNAL try_lock_mutex';
send SELECT "try_lock_mutex_query" as action;

--connection default
SET DEBUG_SYNC='now WAIT_FOR try_lock_mutex';
--echo try_mutex_lock_conn must be waiting for the mutex
--disable_query_log ONCE
eval SELECT SQL_NO_CACHE state FROM INFORMATION_SCHEMA.PROCESSLIST WHERE id='$try_mutex_lock_conn_id';
SET DEBUG_SYNC='now SIGNAL unlock_mutex';

--connection mutex_locked_conn
reap;
--connection try_mutex_lock_conn
reap;

--disconnect mutex_locked_conn
--disconnect try_mutex_lock_conn

--connection default
SET DEBUG_SYNC= "RESET";
SET GLOBAL query_cache_size=default;

--source include/wait_until_count_sessions.inc
