#
# Test that TokuDB CLUSTERING key grammar addition syntax is understood (does not fail with
# ER_PARSE_ERROR), but that non-supporting storage engines reject it by returning
# ER_ILLEGAL_HA_CREATE_OPTION.
#

--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, CLUSTERING KEY b (b));

CREATE TABLE t1 (a INT PRIMARY KEY, b INT);

--error ER_ILLEGAL_HA_CREATE_OPTION
ALTER TABLE t1 ADD CLUSTERING INDEX b (b);

--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE CLUSTERING INDEX b ON t1 (b) LOCK=EXCLUSIVE ALGORITHM=COPY;

--error ER_ILLEGAL_HA_CREATE_OPTION
ALTER TABLE t1 ADD CLUSTERING INDEX b (b), LOCK=EXCLUSIVE, ALGORITHM=COPY;

# CLUSTERING can be combined with UNIQUE, but neither of them can be combined with itself.
# CLUSTERING cannot be the sole key type for a CONSTRAINT.

--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t2 (a INT PRIMARY KEY, b INT, UNIQUE CLUSTERING KEY b (b));
--error ER_PARSE_ERROR
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, UNIQUE UNIQUE KEY b (b));
--error ER_PARSE_ERROR
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, CLUSTERING CLUSTERING KEY b (b));
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t2 (a INT PRIMARY KEY, b INT, CLUSTERING UNIQUE KEY b (b));
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t2 (a INT PRIMARY KEY, b INT, CONSTRAINT c1 UNIQUE CLUSTERING KEY b (b));
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t2 (a INT PRIMARY KEY, b INT, CONSTRAINT c1 CLUSTERING UNIQUE KEY b (b));
--error ER_PARSE_ERROR
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, CONSTRAINT c1 UNIQUE UNIQUE KEY b (b));
--error ER_SYNTAX_ERROR
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, CONSTRAINT c1 CLUSTERING KEY b (b));
--error ER_ILLEGAL_HA_CREATE_OPTION
ALTER TABLE t1 ADD UNIQUE CLUSTERING INDEX b (b);
--error ER_ILLEGAL_HA_CREATE_OPTION
ALTER TABLE t1 ADD CLUSTERING UNIQUE INDEX b (b);
--error ER_PARSE_ERROR
ALTER TABLE t1 ADD UNIQUE UNIQUE INDEX b (b);
--error ER_PARSE_ERROR
ALTER TABLE t1 ADD CLUSTERING CLUSTERING INDEX b (b);
--error ER_ILLEGAL_HA_CREATE_OPTION
ALTER TABLE t1 ADD CONSTRAINT c1 UNIQUE CLUSTERING INDEX b (b);
--error ER_ILLEGAL_HA_CREATE_OPTION
ALTER TABLE t1 ADD CONSTRAINT c1 CLUSTERING UNIQUE INDEX b (b);
--error ER_PARSE_ERROR
ALTER TABLE t1 ADD CONSTRAINT c1 UNIQUE UNIQUE INDEX b (b);
--error ER_SYNTAX_ERROR
ALTER TABLE t1 ADD CONSTRAINT c1 CLUSTERING INDEX b (b);

DROP TABLE t1;

# Test CLUSTERING as a field attribute, alone and in combination with UNIQUE

--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT CLUSTERING);
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT CLUSTERING KEY);
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT CLUSTERING UNIQUE);
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT CLUSTERING UNIQUE KEY);
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT UNIQUE CLUSTERING);
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT UNIQUE CLUSTERING KEY);

# CLUSTERING is not allowed as an identifier due to causing extra shift/reduce parser conflicts
--error ER_PARSE_ERROR
CREATE TABLE CLUSTERING(a INT);


# Check that the grammar changes have not broken related CLUSTERING-less clauses

CREATE TABLE t1 (a INT PRIMARY KEY, b INT, c INT, d INT, e INT, f INT, g INT, UNIQUE KEY b (b));
ALTER TABLE t1 ADD UNIQUE INDEX c (c), LOCK=EXCLUSIVE, ALGORITHM=COPY;
ALTER TABLE t1 ADD CONSTRAINT c1 UNIQUE INDEX g (g);
ALTER TABLE t1 ADD INDEX d (d);
CREATE INDEX e ON t1 (e) LOCK=EXCLUSIVE ALGORITHM=COPY;
CREATE UNIQUE INDEX f ON t1 (f);
DROP TABLE t1;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, KEY b (b));
DROP TABLE t1;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, UNIQUE b (b));
DROP TABLE t1;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT, CONSTRAINT c1 UNIQUE b (b));
DROP TABLE t1;

CREATE TABLE t1 (a INT UNIQUE);
DROP TABLE t1;
CREATE TABLE t1 (a INT UNIQUE KEY);
DROP TABLE t1;


# use with partitioned tables
--error ER_ILLEGAL_HA_CREATE_OPTION
CREATE TABLE t1 (a INT NOT NULL AUTO_INCREMENT, b INT, PRIMARY KEY(a), CLUSTERING KEY b(b)) ENGINE=InnoDB
PARTITION BY RANGE(a) (PARTITION p0 VALUES LESS THAN (100) ENGINE = InnoDB, PARTITION p2 VALUES LESS THAN MAXVALUE ENGINE = InnoDB);
