# Keyring_vault plugin and keyring_vault_config variable testing.

--disable_ps_protocol
--disable_warnings
--source include/not_embedded.inc

call mtr.add_suppression("\\[Error\\] Plugin keyring_vault reported: 'Could not open file with credentials.'");
call mtr.add_suppression("\\[Error\\] Plugin keyring_vault reported: 'Could not read secret_mount_point from the configuration file.'");
call mtr.add_suppression("\\[Error\\] Function 'keyring_vault' already exists");
call mtr.add_suppression("\\[Error\\] Couldn't load plugin named 'keyring_vault' with soname 'keyring_vault.so'.");

call mtr.add_suppression("\\[Error\\] Plugin keyring_vault reported: 'keyring_vault initialization failure.");

call mtr.add_suppression("\\[ERROR\\] Plugin keyring_vault reported: 'Could not retrieve list of keys from Vault. Vault has returned the following error\\(s\\): \\[\"permission denied\"\\]'");
call mtr.add_suppression("\\[ERROR\\] Plugin keyring_vault reported: 'Error while loading keyring content. The keyring might be malformed'");

# Installing keyring plugin.
--replace_regex /\.dll/.so/
eval INSTALL PLUGIN keyring_vault SONAME '$KEYRING_VAULT_PLUGIN';
# Check keyring plugin
query_vertical SELECT PLUGIN_NAME,PLUGIN_VERSION,PLUGIN_STATUS
FROM INFORMATION_SCHEMA.PLUGINS WHERE plugin_name='keyring_vault';
--echo
--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR
eval SET @@global.keyring_vault_config='$MYSQL_TEST_DIR/std_data/keyring_vault_confs/keyring_vault.conf';
--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR
SELECT @@global.keyring_vault_config;
# Creating table with encryption.
CREATE TABLE t1(c1 INT, c2 char(20)) ENCRYPTION="Y" ENGINE = InnoDB;

# Setting keyring_vault_config value to file.
--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR
eval SET @@global.keyring_vault_config='$MYSQL_TEST_DIR/std_data/keyring_vault_confs/keyring_vault2.conf';
--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR
SELECT @@global.keyring_vault_config;

# Invalid values
--error ER_WRONG_VALUE_FOR_VAR
SET @@global.keyring_vault_config='';
--error ER_WRONG_VALUE_FOR_VAR
SET @@global.keyring_vault_config='#^$^@E&(';
--error ER_WRONG_TYPE_FOR_VAR
SET @@global.keyring_vault_config=1;
#This statement generates Could not read secret_mount_point error
#As location can be opened for reading
--error ER_WRONG_VALUE_FOR_VAR
SET @@global.keyring_vault_config='/';
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
--error ER_GLOBAL_VARIABLE
eval SET @@session.keyring_vault_config='$MYSQL_TMP_DIR/new_keyring_vault_config';
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
--error ER_GLOBAL_VARIABLE
eval SET @@local.keyring_vault_config='$MYSQL_TMP_DIR/new_keyring_vault_config';

--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR
--error ER_WRONG_VALUE_FOR_VAR
eval SET @@global.keyring_vault_config='$MYSQL_TEST_DIR/std_data/keyring_vault_confs/keyring_vault_invalid_token.conf';

eval SET @@global.keyring_vault_config='$MYSQL_TEST_DIR/std_data/keyring_vault_confs/keyring_vault.conf';
--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR
SELECT @@global.keyring_vault_config;

# Setting keyring_vault_config value to dir.
--Error ER_WRONG_VALUE_FOR_VAR
SET @@global.keyring_vault_config='MYSQL_test_invalid/dir/';
--replace_result $MYSQL_TEST_DIR MYSQL_TEST_DIR
SELECT @@global.keyring_vault_config;
--echo

UNINSTALL PLUGIN keyring_vault;
# Check keyring plugin
query_vertical SELECT PLUGIN_NAME,PLUGIN_VERSION,PLUGIN_STATUS
FROM INFORMATION_SCHEMA.PLUGINS WHERE plugin_name='keyring_vault';

# Cleanup
DROP TABLE t1;
--let $KEYRING_CONF_FILE=$MYSQL_TEST_DIR/std_data/keyring_vault_confs/keyring_vault.conf
--source ../plugin/keyring_vault/tests/mtr/vault_cleanup.inc
--echo
--echo #End:
